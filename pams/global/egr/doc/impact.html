<header>
<title>Impact Parameter</title>
<!-- Changed by: Alfred C. Saulys, 10-May-2000 -->
</header>

<body bgcolor=ffffff>
<h1 align=center>Impact Parameter Confidence Level Code</h1>
<h3>Introduction</h3>
The method used in this procedure is to:
<ol>
<li>extrapolate global tracks using the <a href="#kalex">Kalman extrapolator</a>
to within a radial distance in XY plane of 3 cm. from the primary vertex
<li>do a <a href="#constrained">constrained fit</a> to require the track to go through the primary
vertex and calculate the Confidence Level that the track goes through
the primary vertex
</ol>

<br>
<br>
<br>
<a name="kalex">
<h3>Kalman Extrapolator</h3>
To extrapolate tracks using the Kalman method a routine (kalex) is
called with the helix parameters at a given point on the track and
the covariance matrix at the point. The step size and the GEANT
particle ID hypothesis must also be supplied. The result is a set
of helix parameters at the cylinder radius specified by R and a
new covariance matrix at the point. If the extrapolation fails a
non-zero value of IRET is returned. The code is Fortran and the
header looks like:
<pre>
      SUBROUTINE KALEX(STEP,RL,PL,CL,R,P,C,IDGEANT,IRET)
*-----------------------------------------------------------------------------
*--
*--   tracking to an inactive detector surface
*--
*--   Input:
*--     RL     ... current radius
*--     PL(5)  ... current reference track
*--     CL(15) ... current cov. matrix
*--     R      ... new radius (<=RL)
*--
*--   Output:
*--     P(5)   ... new reference track
*--     C(15)  ... new cov. matrix
*--
*--   P(1) ...  phi*R
*--   P(2) ...  z
*--   P(3) ...  tanl
*--   P(4) ...  psi
*--   P(5) ...  q/pt
*-- 

C* the correspondence between the COV(15) and COV(5,5) is
C* ( 1  2  3  4  5)  -  phi*R
C* ( 2  6  7  8  9)  -  z
C* ( 3  7 10 11 12)  -  tanl
C* ( 4  8 11 13 14)  -  psi
C* ( 5  9 12 14 15)  -  q/pt

*--   A.C. Saulys June, 1999
*--
*------------------------------------------------------------------------------
</pre>

<br>
<br>
<br>
<a name="constrained">
<h3>Constrained fit code</h3>
The constrained fit code is based on a DELPHI routine cfit) obtained from
V. Perevoztchikov. The code consists of four parts:
<ol>
<li>The interface routine to StPrimaryMaker <a href="#egr_impactcl">(egr_impactcl)</a>
<li>The main fitting routine <a href="#cfit">(cfit)</a>
<li>The interface routine <a href="#impfit">(impfit)</a>
<li>The user routine <a href="#userimpfit">(userimpfit)</a> defining the constraints and the Jacobians
</ol>
<br>
<br>
<br>
<a name="egr_impactcl">
<h3><i>egr_impactcl</i></h3>
This is the module interface for the constrained fit.
<br>
<br>
<br>
<a name="cfit">
<h3><i>cfit</i></h3>
This is Fortran code and the documentation is basically in the header
comments:
<pre>
      SUBROUTINE CFIT (Good, Goodsc, Mode, Isw, G, N1g, C, N1c, Ng, Nc, 
     & Xf, Nx, Gf, N1gf, Xi2, W, USER, Ierr)
************************************************************************
* CFIT                                                                 *
*                                                                      *
*  Created     :  8-JUN-1994   Author : Victor Perevoztchikov          *
*                                                                      *
*  Function    :  Fit with constrains, user routine called for         *
*                 calculation constrains residuals and gradients       *
*                                                                      *
*  References  : None                                                  *
*                                                                      *
*  Arguments   :                                                       *
*    Good      Convergence criterion (residual/error)**2               *
*    Goodsc    Scale factor for convergence for each constraint        *
*                                                                      *
*    Mode      init + 10*Niter                                         *
*              where                                                   *
*              Init      0= G correlation matrix is not used,          *
*                           info from the previous call is used        *
*                           Refit, only Isw and Xf is used             *
*                        2= G is covariant (error) matrix              *
*                        1= G is weight matrix (inverse of error mtx)  *
*              Niter     maximal number of iteration allowed           *
*    Isw       switch array, Isw(1:Nx)=0       fixed variable          *
*                            Isw(Nx+1:Nx+Nc)=0 constrain ignored       *
*    G         error mtx of measured values                            *
*    N1g       first dimension of G                                    *
*    C         mtx contains values of constrains & gradients in Xb+X0  *
*              C(1,N)   == residual of Nth constrain                   *
*              C(1+I,N) == dC(N)/dX(I)                                 *
*    N1c       first dimension of C                                    *
*    Ng        number of measured values, Ng <= N1g                    *
*    Nc        number of constrains, Nc+1 <= N1c                       *
*    Xf        fited corrections X=Xb+Xf                               *
*    Nx        size of X, Nx >= Ng                                     *
*    Xi2       Chisquare of fit                                        *
*    Gf        error matrix of fitted errors                           *
*    N1gf      first dimension of GF                                   *
*    W         work array of size (Nx+Nc)*(Nx+Nc+3)+Ng*Ng              *
*    Ierr      error flag                                              *
*    USER      User routine to calculate C                             *
*              Call USER (Itest, Xf, Nx, C, N1c, Nc, Ifail)            *
*              Where:                                                  *
*              Itest - mode of work                                    *
*                      0=normal                                        *
*                      1=test mode, no modify X                        *
*              Xf - vector of parameters (Input/Output)                *
*              C - MTX of constrains     (Ouput)                       *
*              Ifail    0 = OK                                         *
*                       1 = too big step, cut step is needed           *
*                       9 = stop the fit                               *
*                                                                      *
*  Errors      :                                                       *
*    0 = Ok                                                            *
*    1 = bad error mtx (G)                                             *
*    2 = No solution                                                   *
*    3 = Too many iters                                                *
*    4 = Too many cuts                                                 *
*    9 = Extra big Chisq                                               *
*    10+User stop                                                      *
*                                                                      *
*       Extra output in COMMON/SLATE/ISLAT(40)                         *
*       ISLAT(1) = number of iterations were done                      *
*                                                                      *
************************************************************************
</pre>

<br>
<br>
<br>
<a name="impfit">
<h3><i>impfit</i></h3>
This is the interface routine to the constrained fit main code cfit.
A brief description:
<pre>
      INTEGER*4 FUNCTION impfit(Iter,rxy,pvect,cov,
     +                            bfield,mv,chisq,err)

***********************************************************************
*                                                                     *
* Interface routine to impact parameter fitting package               *
*                                                                     *
* 7 April 2000  AUTHOR: A. C. Saulys , BNL                            *
*                                                                     *
* Iter is maximum number of iterations                                *
* rxy  is the radius from 0,0 for track                               *
* pvect is the helix parameter vector phi*r,z,tanl,psi,q/pt at rxy    *
* cov is the covariance matrix indexed as above                       *
* bfield is the z component of the magnetic field                     *
* mv is the x,y,z of the mv                                           *
* chisq is the change of chisq of the constrained fit                 *
* err is the error matrix of the fit                                  *
*                                                                     *
***********************************************************************
</pre>

<br>
<br>
<br>
<a name="userimpfit">
<h3><i>userimpfit</i></h3>
This is the routine called by cfit to calculate the constraints and
Jacobians for the fit. A brief description:
<pre>
      SUBROUTINE USERIMPFIT (Itstp, Isw, X, Nxp, C, N1cp, Ncp, Ifail)

************************************************************************
*  USERIMPFIT                                                          *
*                                                                      *
*  Created     : 14-Feb-2000   Author : A. C. Saulys                   *
*                                                                      *
*  Function    : Calculates constraints for impact parameter fit       *
*                                                                      *
*  References  : None                                                  *
*                                                                      *
*  Arguments   :                                                       *
*      Itst    0=normal mode,1=test mode                               *
*      Isw     X & C switches                                          *
*      X   -   Vector of values                                        *
*      Nxp -   size of X                                               *
*      C   -   Constraint matrix                                       *
*      N1cp    1st size of C                                           *
*      Ncp     2nd size of C                                           *
*                                                                      *
*  Errors      :                                                       *
*      Ifail   0 = OK                                                  *
*              1 = too big step, cut step is needed                    *
*              9 = stop the fit                                        *
*                                                                      *
*                                                                      *
*       X(1)    phi1*rxy1                                              *
*       X(2)    z1                                                     *
*       X(3)    tanl1                                                  *
*       X(4)    psi1                                                   *
*       X(5)    q1/pt1                                                 *
*                                                                      *
*       X(6)   arclen1                                                 *
*                                                                      *
*       Xb(7)  X at primary vertex                                     *
*       Xb(8)  Y at primary vertex                                     *
*       Xb(9)  Z at primary vertex                                     *
*                                                                      *
*       Xb(10)  rxy1                                                   *
*                                                                      *
************************************************************************
</pre>

<hr>
<i>Last update 11 May 2000 by A.C. Saulys</i>
</body>











