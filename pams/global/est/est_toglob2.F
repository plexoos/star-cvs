      INTEGER*4 FUNCTION EST_TOGLOB2(
     1         est_match_h,         est_match ,
     2             tphit_h,             tphit ,
     3           tptrack_h,           tptrack ,
     4    scs_spt_h,           scs_spt ,
     5            groups_h,            groups ,
     6          stktrack_h,          stktrack ,
     7             match_h,             match ) 
      IMPLICIT NONE
#include "est_toglob2.inc"
CC:>--------------------------------------------------------------------
CC: ROUTINE:    EST_TOGLOB2
CC: DESCRIPTION: Physics Analysis Module FORTRAN 77 template.
CC:             This is a FORTRAN 77 Physics Analysis Module template
CC:             automatically generated by stic Version
CC:        Id: idl.y,v 1.15 1998/10/11 17:41:14 fisyak Exp  
CC:             from est_toglob2.idl.
CC:             Please edit comments and code.
CC: AUTHOR:     hpl - H.P. Lovecraft, hplovecraft@cthulhu.void
CC: ARGUMENTS:
CC:          IN:
CC:        est_match     - description here
CC:      est_match_h     - Header Structure for est_match
CC:            tphit     - description here
CC:          tphit_h     - Header Structure for tphit
CC:          tptrack     - description here
CC:        tptrack_h     - Header Structure for tptrack
CC:       INOUT:
CC:          scs_spt     - description here
CC:        scs_spt_h     - Header Structure for scs_spt
CC:           groups     - description here
CC:         groups_h     - Header Structure for groups
CC:         stktrack     - description here
CC:       stktrack_h     - Header Structure for stktrack
CC:            match     - description here
CC:          match_h     - Header Structure for match
CC:         OUT:
CC: RETURNS:    STAF Condition Value
CC:>--------------------------------------------------------------------
      
      integer i,j,k,igroups,istktrack,imatch

      groups_h.nok=0
      igroups=0
      stktrack_h.nok=0
      istktrack=0
      match_h.nok=0
      imatch=0
      do i=1, est_match_h.nok
         if (est_match(i).flag.eq.1) then
c     filling the sgr_groups table
            do j=1,est_match(i).n_svt_hits
               igroups=igroups+1
               if( igroups .gt. groups_h.maxlen) then
                  EST_TOGLOB2=STAFCV_BAD
                  write(6,*) "Not enough groups allocated quitting"
                  goto 10
               endif

               groups(igroups).ident=5
               groups(igroups).id2=est_match(i).id_hit(j)
               groups(igroups).id1=istktrack+1
            enddo
c     filling the stk_track table
            istktrack=istktrack+1
            if( istktrack .gt. stktrack_h.maxlen) then
               EST_TOGLOB2=STAFCV_BAD
               write(6,*) "Not enough stktracks allocated quitting"
               goto 10
            endif
            stktrack(istktrack).flag=2 ! all the tracks are found w/o the primvertex
            stktrack(istktrack).id=istktrack
            stktrack(istktrack).id_globtrk=0
            stktrack(istktrack).id_match=imatch
            stktrack(istktrack).id_mctrack=0 ! to be filled by the evaluator
            stktrack(istktrack).sec=0
            stktrack(istktrack).nspt=est_match(i).n_svt_hits
            stktrack(istktrack).chisq(1)=0
            stktrack(istktrack).chisq(2)=0
            do k=1,15
               stktrack(istktrack).cov(k)=0
            enddo
            do k=1,10
               stktrack(istktrack).cres(k)=0
               stktrack(istktrack).lres(k)=0
            enddo
            stktrack(istktrack).dedx(1)=0 ! to be filled by the pid module
            stktrack(istktrack).dedx(2)=0
            stktrack(istktrack).impact=0
            stktrack(istktrack).invpt=est_match(i).invp*est_match(i).q
            stktrack(istktrack).phi0=est_match(i).phi0
            stktrack(istktrack).pid=0
            stktrack(istktrack).psi=est_match(i).psi
            stktrack(istktrack).r0=est_match(i).r0
            stktrack(istktrack).tanl=est_match(i).tanl
            stktrack(istktrack).z0=est_match(i).z0

c     filling the svm_evt_match table
            imatch=imatch+1
            if( imatch .gt. match_h.maxlen) then
               EST_TOGLOB2=STAFCV_BAD
               write(6,*) "Not enough svm_match allocated quitting"
               goto 10
            endif
            match(imatch).id=imatch
            match(imatch).idsvt=istktrack
            match(imatch).idsvt_2=0
            match(imatch).idtpc=est_match(i).id_tpctrack
            match(imatch).loop1=1
            match(imatch).loop2=0
            match(imatch).mc_check=0
            match(imatch).pid=0
            match(imatch).quality=0
            match(imatch).quality_2=0
            match(imatch).eta=0
            match(imatch).invpt=est_match(i).invp_tpc
         endif       
      enddo
      
      groups_h.nok=igroups
      stktrack_h.nok=istktrack
      match_h.nok=imatch
         
      
      EST_TOGLOB2=STAFCV_OK
 10   continue
      RETURN
      END
