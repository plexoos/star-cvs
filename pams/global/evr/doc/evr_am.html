<pre><h3>INTEGER*4 FUNCTION EVR_AM(
            evrpar_h,            evrpar ,
            globtrk_h,           globtrk ,
            privert_h,           privert )
</h3>
#include "evr_am.inc"
#include "math_constants.inc"
#include "phys_constants.inc"
#include "StDetectorId.inc"
#include "StVertexId.inc"

CC:>----------------------------------------------------------------------
CC: ROUTINE:    EVR
CC: DESCRIPTION: Vertex fit, least square method with outlier removal
CC: AUTHOR:     S. Margetis  Created  MARCH-1992
CC: ARGUMENTS:
CC:          IN:
CC:             evrpar   = Parameters controlling vertex finding
CC:             globtrk  = Track information from egr package; uses the
CC:                        first instance of the global track table
CC:                        corresponding to the fit or refit of only the
CC:                        space points from the tracking detectors.
CC:         OUT:
CC:             privert  = Primary Vertex Information
CC:      UPDATE:
CC:             globtrk.id_start_vertex -- used to indicate primary
CC:                        track candidates based on 3D DCA cut from
CC:                        the found primary vertex; also used to indicate
CC:                        which tracks were used in the final primary
CC:                        vertex fit (see following explanation of
CC:                        packing algorithm).
CC:             globtrk.impact -- Three dimensional distance of closest
CC:                               approach (3D DCA) to the final primary
CC:                               vertex for all good global tracks (i.e.
CC:                               those with iflag > 0) which have
CC:                               TPC and/or SVT and/or SSD space points
CC:                               (not FTPC tracks).
CC:
CC:     Output variables in table privert:
CC:     ----------------------------------
CC:     privert().id        = Primary key; value of privert_h.nok when
CC:                           row is filled
CC:               iflag     = 1 for normal, successfully found primary vertex
CC:                             during the 3rd iteration
CC:                         = -3 for initial seed value
CC:                         = -2 for first iteration value
CC:                         = -1 for second iteration value
CC:                         = -4 for failed fit with Determinant of G = 0.0,
CC:                              occuring during any iteration.
CC:                         = -5 for failed error covariance matrix evaluation
CC:                              during fit with Determinant of E = 0.0,
CC:                              occuring during any iteration.
CC:               det_id    = Detectors contributing to all tracks used for
CC:                           primary vertex finding/fitting:
CC:                           This quantity, based on the definitions in
CC:                           $STAR/pams/global/inc/StDetectorDefinitions.h,
CC:                           indicates the full
CC:                           list of tracking detectors which contributed
CC:                           to all the tracks used in determinig the primary
CC:                           vertex.  This might include the SVT, SSD and
CC:                           TPC.  The FTPCs are not included in this, nor
CC:                           in the primary vertex finding process.  The
CC:                           tracks from the initial global track selection
CC:                           loop (do 20 loop) are used for this determination.
CC:                           The 'det_id' from this initial, selected set of
CC:                           tracks is reported for each primary vertex
CC:                           iteration. The following algorithm is used:
CC:                           
CC:                           Detectors contributing        Value assigned to
CC:                              to tracks used             privert().det_id
CC:                           -----------------------------------------------
CC:                           TPC only                      kTpcId
CC:                           SVT only                      kSvtId
CC:                           SSD only (nonsense case)      kSsdId
CC:                           TPC & SVT, not SSD            kTpcSvtId
CC:                           TPC & SSD, not SVT            kTpcSsdId
CC:                           SSD & SVT, not TPC            kSsdSvtId
CC:                           SVT, SSD and TPC              kTpcSsdSvtId
CC:                           -----------------------------------------------
CC:               vtx_id    = kEventVtxId (defined in $STAR/pams/global/inc/
CC:                           StVertexDefinitions.h),
CC:                           indicates the primary vertex
CC:             n_daughters = number of tracks used at each iteration in the
CC:                           fit; only good global tracks with SVT and/or
CC:                           SSD, and/or TPC segments are used and counted.
CC:                           FTPC tracks are not used and are not counted.
CC:             x,y,z       = Primary vertex coords in STAR global c.s. (cm)
CC:          covar(1,2...6) = Covariance error matrix for vrtx position (cm^2)
CC:                           defined in DST document for table dst_vertex.
CC:                chisq(2) = Chi-Square of fit per d.o.f. (number of tracks
CC:                           used minus number of varied quantities, the latter
CC:                           corresponds to one vertex position, so #d.o.f. =
CC:                           ntrks-used - 1).  The second value is the 
CC:                           probability of chi-square calculated using the
CC:                           CERNLIB function PROB(X,N).
CC:            id_aux_ent   = 0; used by ev0 for auxiliary vertex table
CC:                              reference, not used by evr.
CC:
CC:     Update variables in table globtrk:
CC:     ---------------------------------
CC:         id_start_vertex = {0, if track is not used in final vertex fit;
CC:                           OR 1, if track is used in final vertex fit}
CC:                           + {10 * privert(final prim. vrtx row#).id,
CC:                              if track passes 3D DCA cut}
CC:                           
CC:                           This marks all global tracks with respect to
CC:                           usage in final primary vertex fit and with
CC:                           respect to a 3D DCA cut from the found primary
CC:                           vertex using the distance cut in
CC:                           evrpar(1).vcut.
CC:         impact          = Three dimensional distance of closest
CC:                           approach (3D DCA) to the final primary
CC:                           vertex for all good global tracks (i.e.
CC:                           those with iflag > 0) which have
CC:                           TPC and/or SVT and/or SSD space points
CC:                           (not FTPC tracks).
CC:                           
CC: RETURNS:    STAF Condition Value
CC:     The code returns one of the following condition values:
CC:
CC:          STAFCV_OK      - indicates normal, successful completion of
CC:                           vertex finding all the way to the final, third
CC:                           fit iteration; indicates to the calling
CC:                           program that event processing should continue.
CC:                           
CC:          STAFCV_BAD     - occurs if number of global tracks < 5, or if
CC:                           number of global tracks < ntrkcut (=50) and
CC:                           number of selected tracks at any step in the
CC:                           processing is < 5.  This indicates to the
CC:                           calling program that the event multiplicity
CC:                           is too small for this module to work.  An
CC:                           alternate, small event primary vertex finder
CC:                           should be called instead of evr_am.  For example,
CC:                           the peripheral collision group's primary vertex
CC:                           module.  This return value may also indicate 
CC:                           that the vertex table (privert) had an
CC:                           insufficient number of rows such that the
CC:                           primary vertex could not be written into it.
CC:                           The calling program should increase the
CC:                           number of assigned rows to table privert and
CC:                           call evr_am again.
CC:                           
CC:          STAFCV_ERR     - occurs if the number of global tracks => ntrkcut
CC:                           (equal to 50) and the number of selected tracks
CC:                           at any step in the processing is < 5.  This
CC:                           indicates to the calling program that a serious
CC:                           failure in evr processing has occured, no
CC:                           primary vertex could be found even though the
CC:                           event multiplicity was large; event 
CC:                           processing should be terminated.
CC:                           
CC: ERROR CONDITIONS    : None-Yet
CC: STATUS              : Tested
CC:
CC:  METHOD:
CC:  Minimization of the perpendicular distances from the vectors to a point.
CC:
CC:  Consider an arbitrary vector Vi, with a unit vector in the direction
CC:  The distance from a point P to the vector Vi is the crossproduct of the 
CC:  unit vector e(Vi)^ with any line connecting P to any point Q on the line.
CC:  Line PQ = (x0-xi)x^+(y0-yi)y^+(z0-zi)z^
CC:     P=(x0,y0,z0)    Q=(xi,yi,zi)
CC:  The distance is: |d|=|PQ X e(Vi)^|
CC:
CC:  A least square minimization employs a merit function (chi square) to 
CC:  assess quality of fit.  The optimum values of the variables are 
CC:  determined by where the partial derivatives of the merit function are
CC:  equal to zero.  For this case, the merit function is the summation of
CC:  the squares of the perpendicular distances from the vectors (Vi) to a 
CC:  point (Xo, Yo, Zo) [divided by the squares of the uncertanty
CC:  errors?] (sumation over vector number).  The partial derivatives are taken
CC:  with respect to x0, y0, and Z0.  We are left with three equations 
CC:  for three unknowns (Xo,Yo,Zo).  The evaluation is done through matrix 
CC:  manipulation.
CC:
CC:>----------------------------------------------------------------------



</pre>
