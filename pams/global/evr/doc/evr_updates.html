<pre><h3> EVR - Package Updates </h3>


 MODIFIED  IN STAF : S. Margetis, December 1998
   Changed input of magnetic field, evr parameters. Now it
        marks by default the vertex tracks.

 MODIFIED TO WORK IN STAF : S. Margetis, November 1996

 MODIFIED TO WORK IN TAS : E. G. Judd, November 1993
   Added switches so the vertex finder can use TPC, SVT or global tracks.
         Also added cuts on pt, and whether or not the track has been
         matched, to improve track selection : E. G. Judd, April 1994

 AUTHORS:     S. Margetis  Created  MARCH-1992
              L. Ray, Modified and Maintained from February 1999 - present

  Modified for greater accepted range in z for vertex position; array
  bounds checking; unused array cleanup; and bug fixes by L. Ray on
  Feb. 22, 1999

  Following modifications by R.L.Ray during May, 1999:
  (1)  Include optional re-calculation of helix track projection and
       distance of closest approach (DCA) determination for new
       vertex position at each iteration.
  
  (2)  Save initial vertex seed position as well as iterations 1 and 2
       values in privert table with iflag values set as noted above.
  
  (3)  Compute primary vertex covariance matrix and save diagonal
       components in table privert.
       CHANGE July 1999: Save complete primary vertex position covariance
                         matrix in privert().covar[6]
  
  (4)  Estimate multiple Coulomb scattering (MCS) error contribution to
       the uncertainty (sigma) in the extrapolated track position at the
       DCA point.  Use in vertex fit.  Assumes all tracks are TPC only
       and that MCS in TPC inner field cage is dominant effect.  Uses
       spatial rms MCS angle.  Assumes pion mass for MCS angle calculation
       for all tracks.

       NOTE:  This part will need to be generalized when global tracks
              include SVT tracks and SVT-TPC matched tracks.
       CHANGE July 1999: code checks for SVT or SSD track segments and
                         if these occur an effective SVT radiation 
                         thickness for the first SVT layer is used to
                         estimate the MCS sigma. 
  
  (5)  Modified/corrected helix projection subroutine.
  
  (6)  Include straight track (no B field case) track projection.
  
  (7)  Modified/corrected 3-D DCA subroutine for special case.
  
  (8)  General cleanup and QA verification.
  
  (9)  Use input global track covariance matrix to calculate the
       track position uncertainty at the extrapolated DCA point.
       Use this as an error (sigma) in the i-th track DCA point
       and add in quadrature with the MCS error.
       CHANGE July 1999: Use the Kalman filter/fitter definition; use
                         new global track table (dst_track) with full
                         track fit covariance matrix; use of old
                         globtrk_aux removed.

 (10)  Compute chi-square per track used in fit and save in
       privert().pchi2
       CHANGE July 1999: Compute chi-square per degree of freedom and
                         probability of chi-square and save in
                         privert().chisq(1,2), respectively.

  Additional changes made in July 1999 by R. L. Ray:

 (11)  Use Detector ID and Vertex ID codes defined in $STAR/pams/global/inc/
       StDetectorDefinitions.h and StVertexDefinitions.h

 (12)  Modified code for no magnetic field case.  If abs(Bz).le.0.001 kGauss,
       Bz is set to 0.0.  In order to have some estimate of the MCS error
       an arbitary value of pT = 0.4 GeV/c is assumed.  The charge is also
       assumed to be +1 for the no B field runs.

 (13)  Calculate 3D DCA to final primary vertex for all good global tracks
       and load into globtrk().impact.

 (14)  Modified for new global track parameters r0,phi0 - 9/29/99 (L.Ray)

 (15)  Corrected handling of anomalously small values of extrapolated
       track position errors; hard coded pion mass (0.14) in multiple
       Coulomb scattering estimate - R. L. Ray, March, 2000.

 (16)  Revised the event abort criteria and diagnostic output - R. L. Ray,
       April, 2000.

 (17)  Use weighted means for initial seed values for vertex z-position
       and for x,y-positions for the case when the beam-beam axis is not
       coincident with the x = y = 0 axis - R. L. Ray, April, 2000.

 (18)  Replaced math library functions sind and cosd with locally
       defined functions - R. L. Ray, April, 2000.

 (19)  Added extra track selection criteria based on a minimum number of
       space points used in the global track fit - R. L. Ray, April, 2000.

CC:
CC: (20)  Changed most Real variables to Real*8 and used explicit double
CC:       precision functions, e.g. dsin(), etc. - Nov. 2000, G. van Buren.
CC:
CC:  Changes in Feb.-April 2001 - R. L. Ray
CC:
CC: (21)  Include Year 2000 run's beam line coordinates in vertex fit with
CC:       small error in order to constrain the transverse vertex position
CC:       for low multiplicity events.  Numbers are hardwired into code and
CC:       should only be used for production of real Y2K data.
CC:       Use the beamline coordinates from Jamie Dunlop's analysis, Mar. 21,
CC:       2001; see http://www.star.bnl.gov/protected/spectra/dunlop/
CC:       vertex_Mar202001/.  Activate this constraint by setting parameter
CC:       evrpar(1).fitoption = 2; otherwise the error associated with the
CC:       beam line is set to 100. cm which effectively removes it from the
CC:       fitting.  The latter should be done for simulations.
CC:
CC: (22)  Extend vertex search region to include full beam pipe volume out 
CC:       to +/- 6m, but only proceed with vertex fitting if seed is within
CC:       TPC, or if |z_seed| <= 2m.  Also, only tracks with DCA points
CC:       within the sequence of z-bins near the seed are used to determine
CC:       the <x>, <y> of the vertex seed.
CC:
CC: (23)  Use variable DCA binning as determined using parameter values
CC:       in code; but use 2x larger z-DCA bins for low multiplicity events
CC:       where globtrk_h.nok <= 50.
CC:
CC: (24)  Track DCA acceptance for each iteration of the vertex
CC:       fit is based on distance cuts computed from the rms of the
CC:       z distribution in the z-DCA sequence.  Preset DCA cuts are
CC:       no longer used directly but are used to limit the computed cuts.
CC:
CC:       New track acceptance criteria:
CC:        a) For the initial seed finding use all DCA points to the x=y=0
CC:           z-axis that lie within the beampipe volume and |z| <= 6m.
CC:        b) Select and proceed with fitting for seeds with <z> within
CC:           TPC as specified from -zrange to +zrange (zrange = 200 cm).
CC:        c) Check #tracks associated with seed Z-DCA sequence and if
CC:           .lt. ntrkratiocut*(globtrk_h.nok - 50) then STOP vertex find/fit
CC:           and return to calling program with STAFCV_BAD.
CC:        d) Fill x,y DCA histograms for sqrt(x*x+y*y) within beampipe and
CC:           for z within z-DCA sequence range, the latter is nominally
CC:           <z> of seed +/- 'def_seq_range_z' (=2cm).
CC:        e) For First fit iteration:
CC:              select tracks with z-DCA within seed sequence range along
CC:              z-axis and transverse x,y DCAs within the larger of
CC:                 evrpar(1).cutxy OR 3*sqrt(2)*sigmaz,
CC:              but not larger than the beampipe radius, in transverse
CC:              distance from the vertex seed.
CC:        f) For Second fit iteration:
CC:              select tracks with DCA point within 3D distance of the
CC:              larger of 2*sqrt(3)*sigmaz or evrpar(1).cut2, but not
CC:              larger than 2*sqrt(3)*sigdef, where sigdef = 1.0 cm.
CC:        g) For Third (final) fit iteration:                 
CC:              select tracks with DCA point within 3D distance of the   
CC:              larger of sqrt(3)*sigmaz or evrpar(1).cut3, but not
CC:              larger than sqrt(3)*sigdef, where sigdef = 1.0 cm.
CC:
CC:           where  sigmaz = rms of z-DCA sequence
CC:                  sqrt(2)*sigmaz = two-dimensional Gaussian rms
CC:                  sqrt(3)*sigmaz = three-dimensional Gaussian rms
CC:
CC:        h) For primary track candidate marker, use 3D DCA from final
CC:           vertex with evrpar(1).vcut as before.
CC:
CC: (25)  Track fit covariance matrix automatically used if globtrk.method
CC:       is 2**kKalmanFitId (i.e., if the Kalman track fitter was used).
CC:
CC: (26)  Changed minimum track number and track ratio requirements to:
CC:        a) minimum number of tracks at each step must be .ge. ntrkcut (=3)
CC:        b) initial number of selected tracks from DO 20 loop must be
CC:           .ge. ntrkratiocut (=0.1)*(globtrk_h.nok)
CC:        c) for all subsequent iterations the ratio of the number of
CC:           accepted tracks after each cut to the total number in the seed
CC:           z-DCA sequence volume must be .ge. the ratio of the 3D dca_cut3
CC:           volume to the z-DCA sequence volume, where these are given by:
CC:                3D dca_cut3 Vol. = (4*pi/3)*(dca_cut3**3)
CC:                z-DCA seq. Vol.  = pi*(beampipe radius**2)*(length of seq)
CC:           For problematic cases the default 'ntrkratiocut' = 0.1 is used.
CC:
CC: (27)  Reduced the array sizes for local track arrays from 20000 to 5000
CC:       to better match the actual size of RHIC AuAu events.
CC:
CC: (28)  Increased the required number of hits on selected tracks from 10
CC:       to .ge. 25.


</pre>
