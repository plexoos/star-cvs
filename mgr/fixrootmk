#!/usr/bin/env perl

#
# This shift/noshit selection is always a mess ...
# Get around by fixing ROOT make file + some special actions
# we need to perform due to an AFS based installation.
#
# (c) J. Lauret 2003 - 2007
# 
#

$CERNL = $ENV{CERN_LEVEL};
$CERN  = $ENV{CERN};

if ( ! defined($CERNL) ){
    die "No CERN_LEVEL defined. Cannot proceed.\n";
}
if ( ! defined($CERN) ){
    print "CERN defined as /cern\n";
    $CERN = "/cern";
}

if ( ! -e "config/Makefile.config"){
    die "You are probably not in the proper directory\n";

} 


# we can then restore things undone before
print "Checking etc/ files\n";
foreach $file (("system.rootrc","root.mimes")){
    if ( -l "etc/$file.new" && ! -l "etc/$file"){
	print "  Establishing etc/$file\n";
	$link = readlink("etc/$file.new");
	$link =~ s/\.new//;
	if ( -f "etc/$file" ){  unlink("etc/$file");}
	system("/bin/ln -s $link etc/$file");
    } elsif ( -e "etc/$file"){
	if ( ! -e "etc/$file.new"){
	    print "  WARNING Could not find $file.new\n";
	} else {
	    print "  Unlinking $file\n";
	    unlink("etc/$file");
	}
    }
}


# This was added in 2007/10 JL - lack of local copy disturbs
# the make process
if ( -l  "config.status" ){
    my($f)=readlink("config.status");
    unlink("config.status");
    system("/bin/cp -p $f ./config.status");
    if ( ! -e "config.status"){
	die "We failed to copy $f to ./config.status - Please fix manually\n";
    }
}


#+
# Now back on the shift stuff, the main purpose of this helper script
#-
if ( ! -e "$CERN/$CERNL/lib/libpacklib_noshift.a"){
    die "$CERN/$CERNL/lib/libpacklib_noshift.a does not exist. Would not know what to do...\n";
}


open(FI, "config/Makefile.config");
open(FO,">config/Makefile.config.new");

$done = 0;

while ( defined($line = <FI>) ){
    chomp($line);
    if ($line =~ m/CERNLIBS\s+:=\s*$/){
	print FO "CERNLIBS := $CERN/$CERNL/lib/libpacklib_noshift.a $CERN/$CERNL/lib/libkernlib.a\n";
	print    "CERNLIBS := $CERN/$CERNL/lib/libpacklib_noshift.a $CERN/$CERNL/lib/libkernlib.a\n";
	$done = 1;
    } elsif ( $line =~ m/BUILDHBOOK/){
	# Introduced at ROOT 4.04.02
	print FO "BUILDHBOOK := yes\n";
    } else {
	print FO "$line\n";
    }
}
close(FI);
close(FO);



if ($done){
    rename("config/Makefile.config",    "config/Makefile.config.old");
    rename("config/Makefile.config.new","config/Makefile.config");

    print "config/Makefile.config fixed\n";
} else {
    print "config/Makefile.config already fixed\n";
    unlink("config/Makefile.config.new");
}

