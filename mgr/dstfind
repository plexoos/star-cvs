#!/usr/local/bin/perl
# Find all DST files on disk and create kumac to load new ones
# into DB
# T. Wenaus
$topPrefix="/disk00001/star/";
#$topLevel="auau200";
#$topLevel="tfs_dst";
$topLevel = shift(@ARGV) || "auau200";
if ( open(SCRIPT,"> newdst2db.kumac") ) {
    print "newdst2db.kumac created to load DST files into DB\n";
} else {
    print "Unable to create DB loader kumac; cannot write locally\n";
}
$theTime = localtime(time());
print SCRIPT "* New XDF DST files as of $theTime\n";
open(FILES, "cd $topPrefix; find $topLevel/ -name '*dst.xdf' |")
 or die "Failed on xdf file seek\n";
$totalsize = 0;
$nfiles = 0;
$nnew = 0;
while (<FILES>) {
  $fullpath = $_;
  @tokens = split(/\//);
  $totalsize += $tokens[4];
  $nfiles++;
  $fname = $tokens[$#tokens];
  $thepath = $topPrefix.$fullpath;
  $thepath =~ s/$fname//;
  chomp($fname);
  $dbname = "/star/sol/db/stardb/dst/$fname.STAR.DB";
  $dbnamef = "/star/sol/db/stardb/dst/$fname"."f".".STAR.DB";
  if ( -e $dbname || -e $dbnamef ) {
#    print "File $dbname exists\n";
  } else {
#    print "$fname not in database\n";
    print SCRIPT "exec xdf2db XDFPATH=$thepath XDFFILE=$fname\n";
    $nnew++;
  }
}
print "Total of ",$nfiles," files under $topLevel, ",$nnew," of them new and not in DB\n";
