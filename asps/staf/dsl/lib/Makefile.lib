#cet(3/22/94)try at rsgi01.rhic.bnl.gov
#cet(3/8/94)#BASE_PATH=../13aug93
#cet(17aug94)-rsgi02:/usr/local/bin/gcc
#whg(28aug95)removed vxworks and bin stuff
#whg(28aug95)disabled vpath for %.o - does not work right ??
#whg(01mar95)split into Makefile and Makefile.lib
#cet(24may95)make work on solaris (sirius.rhic.bnl)
#
#CC=gcc
CFLAGS= -g
CPPFLAGS= -I. -I$(HPATH)
LIB=libdsl.a
LIBCFILES=dscheck.c dsdata.c dserror.c dsjoin.c dslib.c dslock.c\
	dsmem.c dsprint.c dsqsort.c dstable.c dstid.c dstodo.c dstype.c\
	dsutil.c dsxdrlib.c
#	dsutil.c dsxdrlib.c xdrtape.c
LIBCXXFILES=dscpp.cpp
LIBFILES=$(LIBCXXFILES) $(LIBCFILES)
LIBOBJ= $(patsubst %.cpp,%.o, $(LIBCXXFILES)) $(patsubst %.c,%.o, $(LIBCFILES))
vpath %.c $(SPATH)
vpath %.cpp $(SPATH)
vpath %.h $(HPATH)
#

all: lib

test:
	@echo $(HPATH)
	@echo $(SPATH)
	@echo $(LIBOBJ)
	@echo $(ARCH) $(ARCH)  $(ARCH)
	@echo $(CPPFLAGS)

lib:	$(LIB)

$(LIBOBJ) : dscpp.h dscodes.h dstype.h dsxdr.h

dscodes.h:	stamp-dscodes

stamp-dscodes:	tmp-dscodes.h
		if cmp -s tmp-dscodes.h $(HPATH)/dscodes.h ; then\
			echo dscodes.h not changed ; else \
			cp tmp-dscodes.h $(HPATH)/dscodes.h; fi
		touch stamp-dscodes

tmp-dscodes.h:	$(LIBFILES)
		echo "	/* tmp-dscodes.h - GENERATED BY MAKE - DO NOT EDIT */"\
			>tmp-dscodes.h
		echo "#ifndef DSCODES_H" >>tmp-dscodes.h
		echo "#define DSCODES_H" >>tmp-dscodes.h
		echo "typedef enum ds_error_code_t {" >>tmp-dscodes.h
		echo "	DS_E_OK = 0," >>tmp-dscodes.h
		grep "_ERROR(DS_E_"  $^ |sed -e 's/.*(/	/p'|\
		sed -e 's/).*/,/' | sort -u |grep -v DS_E_OK >>tmp-dscodes.h
		echo "	DS_E_CODE_COUNT" >>tmp-dscodes.h
		echo "}DS_ERROR_CODE_T;" >>tmp-dscodes.h
		echo "#endif /* DSCODES_H */" >>tmp-dscodes.h

%.o : %.cpp
	$(CXX) $(CPPFLAGS) $(CCFLAGS) -c $<

$(LIB):		$(LIBOBJ)
		ar r $@ $?
		-ranlib $@

clean:		cleancodes
		-rm $(LIB) $(LIBOBJ)

cleancodes:
		-rm stamp-dscodes tmp-dscodes.h

