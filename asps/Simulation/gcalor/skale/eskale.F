* $Id: eskale.F,v 1.1.1.1 2004/01/15 00:08:49 potekhin Exp $
* $Name:  $
#include <commons/config.h>
      SUBROUTINE ESKALE(IE,EHICUT,FIN,NOFAS,ITSLO,EFAS,ALPFAS,BETFAS,
     + GAMFAS,WTFAS,RMFAS,EXFAS,REFAS,NOSLO,ESLO,ALPSLO,BETSLO,GAMSLO)
C
C changed 10 Nov. 1992 C.Zeitnitz
C
      DIMENSION FIN(*)    , ITSLO(*)   , EFAS(*)    , ALPFAS(*)  ,
     +          BETFAS(*) , GAMFAS(*)  , WTFAS(*)   , ESLO(*)    ,
     +          ALPSLO(*) , BETSLO(*)  , GAMSLO(*)  , ITSLO2(200),
     +          EFAS2(200), WTFAS2(200), ALPFA2(200), BETFA2(200),
     +          GAMFA2(200)
C
#include "gcalor/cinout.inc"
#include "gcalor/cbert.inc"
C
      REAL*8 F,PRTIN2,FEINC
      REAL*4 W
C
      DATA F /0.95D0/
      DATA W /0.2/
      SAVE
C
      IND = 1
      EINC = DBLE(FIN(3))
      EPART= FIN(3)
      FIN(3) = EHICUT
      FEINC = DBLE(EHICUT) * F
      PRTIN2 = DBLE(FIN(7)) + 1.D0
C**
C**        NEP = NO. OF ESCAPING PARTICLES
C**
   10 NEP = IDINT(ESPS(1) + 1.0D-2)
C
C**      CHECK FOR PIONS
C
      J = 2
      DO 20 I = 1,NEP
         IF(ESPS(J).GE.3.D0) GO TO 50
         J = J + 8
   20 CONTINUE
      ITEST1 = ITEST1 + 1
      J = 2
      DO 40 I=1,NEP
C
C**      CHECK FOR ESCAPING PARTICLE SAME AS INCIDENT PARTICLE
C
         IF(ESPS(J).NE.PRTIN2) GO TO 30
C
C**      CHECK FOR ENERGY OF ESCAPING PARTICLE GREATER THAN F * ENERGY
C**      OF INCIDENT PARTICLE
C
         IF(ESPS(J+1).GT.FEINC) GO TO 60
   30    J = J + 8
   40 CONTINUE
C
C**      A 'NON-ELASTIC' COLLISION HAS OCCURRED
C
   50 GO TO (160 ,120),IND
C
C**      AN 'ELASTIC' COLLISION HAS OCCURRED
C
   60 CONTINUE
   70 GO TO (80,110),IND
   80 ATAR = FIN(1)
      NKEY = 2
      NELAST = NELAST + 1
      ITINC = FIN(7)
      CALL MCMOSC(NKEY,ATAR,ITINC,EPART,EHICUT,NOSLO,ITSLO,ESLO,
     + ALPSLO,BETSLO,GAMSLO,EFAS,WTFAS,ALPFAS,BETFAS,GAMFAS,RMFAS,
     + NOFAS,EXFAS,REFAS,WHY)
      NOFAS1 = NOFAS
      IF(NOFAS1.GT.0) GO TO 90
      IE = 2
      GO TO 170
C
C**      MULTIPLY ALL PARTICLE WEIGHTS FOR THIS COLLISION BY W
C
   90 DO 100 I=1,NOFAS1
         WTFAS(I) = WTFAS(I) * W
  100 CONTINUE
  110 IBERT = 1
      CALL CABERT(IBERT,FIN,NOSLO,ITSLO2,ESLO,ALPSLO,BETSLO,GAMSLO)
      IF(NOSLO.LE.0) GO TO 110
      IND = 2
      GO TO 10
  120 CALL MCMOSC(NKEY,ATAR,ITINC,EPART,EHICUT,NOSLO,ITSLO2,ESLO,
     + ALPSLO,BETSLO,GAMSLO,EFAS2,WTFAS2,ALPFA2,BETFA2,GAMFA2,RMFAS2,
     + NOFAS2,EXFAS2,REFAS2,WHY)
      IF(NOFAS2.LE.0) GO TO 110
C
C**      MULTIPLY ALL PARTICLE WEIGHTS BY 1.-W
      W2 = 1.0 - W
      DO 130 I=1,NOFAS2
         WTFAS2(I) = WTFAS2(I) * W2
  130 CONTINUE
C
C**      COMBINE TWO COLLISIONS
C
      IF(NOFAS1 + NOFAS2.LE.60) GO TO 140
      WRITE(IO,10000) NOFAS1,NOFAS2
10000 FORMAT(' HETC: Too many particles in ESKALE -- NOFAS1 = ',I2,
     +       ' NOFAS2 = ',I2)
      IF(NOFAS1.EQ.60) NOFAS1 = 59
      NOFAS2 = 60 - NOFAS1
  140 NOFAS = NOFAS1 + NOFAS2
      DO 150 I = 1,NOFAS2
         J = NOFAS1 + I
         ITSLO(J) = ITSLO2(I)
         EFAS(J) = EFAS2(I)
         WTFAS(J) = WTFAS2(I)
         ALPFAS(J) = ALPFA2(I)
         BETFAS(J) = BETFA2(I)
         GAMFAS(J) = GAMFA2(I)
  150 CONTINUE
      EXFAS = EXFAS * W + EXFAS2 * (1.-W)
      RMFAS = RMFAS * W + RMFAS2 * (1.-W)
      REFAS = REFAS * W + REFAS2 * (1.-W)
      IE = 3
      GO TO 170
  160 IE = 1
  170 FIN(3) = SNGL(EINC)
      RETURN
      END
