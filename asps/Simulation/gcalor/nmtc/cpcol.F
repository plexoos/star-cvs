* $Id: cpcol.F,v 1.1.1.1 2004/01/15 00:08:49 potekhin Exp $
* $Name:  $
#include <commons/config.h>
      SUBROUTINE CPCOL(IB,ITYP,HSIG,EC,NOPART,KIND,EP,ALF,BET,GAM)
C
#include "gcalor/cinpu.inc"
#include "gcalor/cjoint.inc"
#include "gcalor/cisobr.inc"
#include "gcalor/cxpd.inc"
#include "gcalor/crun.inc"
#include "gcalor/cinout.inc"
#include "geant321/crandm.inc"
#include "gcalor/cbert.inc"
      REAL*8   DCLN(80),DCIN(115),PPAC(19),POAC(19),
     + FMXSN(161),FMXDN(130),FMXSP(117),PDCI(60),PDCH(55),DCHN(143),
     + DCHNA(36),DCHNB(60),PSPCL(158),PDPCL(130),SPCLN(158),DPCLN(130),
     + FSLN(176),FRINN(161),DMIN(101),PPSCL(117),PNSCL(117),PMSCL(117),
     + PNNSL(117),PCFSL(234),FRIPN(117),PNMI(101),PNFSL(234),PNEC(126),
     + PNNEC(126),PMXC(126),PMEC(126),PPEC(126),PEC(176),ECN(176),
     + PPDC(6426),PMDD(6426),PMDX(6426),PNDD(6426)
      EQUIVALENCE (TAPCRS(1),DCLN(1)) ,(TAPCRS(81),DCIN(1)) , (TAPCRS(1
     +96),PPAC(1)) ,(TAPCRS(215),POAC(1)) , (TAPCRS(234),FMXSN(1)) ,
     +(TAPCRS(395),FMXDN(1)) , (TAPCRS(525),FMXSP(1)) ,(TAPCRS(642),
     +PDCI(1)) , (TAPCRS(702),PDCH(1)) ,(TAPCRS(757),DCHN(1)) , (TAPCRS
     +(900),DCHNA(1)) ,(TAPCRS(936),DCHNB(1)) , (TAPCRS(996),PSPCL(1))
     +,(TAPCRS(1154),PDPCL(1)), (TAPCRS(1284),SPCLN(1)),(TAPCRS(1442),
     +DPCLN(1)), (TAPCRS(1572),FSLN(1)) ,(TAPCRS(1748),FRINN(1))
      EQUIVALENCE (TAPCRS(1909),DMIN(1)) ,(TAPCRS(2010),PPSCL(1)),
     +            (TAPCRS(2127),PNSCL(1)),(TAPCRS(2244),PMSCL(1)),
     +            (TAPCRS(2361),PNNSL(1)),(TAPCRS(2478),PCFSL(1)),
     +            (TAPCRS(2712),FRIPN(1)),(TAPCRS(2829),PNMI(1)) ,
     +            (TAPCRS(2930),PNFSL(1)),(TAPCRS(3164),PNEC(1)) ,
     +            (TAPCRS(3290),PNNEC(1)),(TAPCRS(3416),PMXC(1)) ,
     +            (TAPCRS(3542),PMEC(1)) ,(TAPCRS(3668),PPEC(1)) ,
     +            (TAPCRS(3794),PEC(1))  ,(TAPCRS(3970),ECN(1))  ,
     +            (TAPCRS(4146),PPDC(1)) ,(TAPCRS(10572),PMDD(1)),
     +            (TAPCRS(16998),PMDX(1)),(TAPCRS(23424),PNDD(1))
C
      DIMENSION KIND(60),EP(60),ALF(60),BET(60),GAM(60)
      DIMENSION ICC(12)
      SAVE
C
      KE =1
      IF(IB)30,10,30
   10 IB =1
      AND1T = DBLE(ANDT)
CZ BERT dataset already read by CRBERT called by CALINI 19.june 92
      SF = 1.D0
      RANDI(1) = 16896
      PNMS = .708D13
C     PI+ OR - MASS IN PER CM.
      DNCMS = 4.758D13
C     NUCLEON MASS IN PER CM.
      SQNM=DNCMS*DNCMS
C     NUCLEON MASS SQD.
      RCPMV = .50613D11
C     RECIPROCAL CM PER MEV.
      POMS = .684D13
C     PIO MASS IN RECIP. CM
      DO 20 I = 1,19
         POAC(I) = POAC(I) + POAC(I)
   20 PPAC(I) = PPAC(I)/SF
C     POAC(19),PPAC(19)
   30 DO 40 I =1,60
   40 IPEC(I) =0
      DO 50 I =1,2114
   50 ESPS(I) = 0.D0
      DO 60 I = 4515,4849
   60 ESPS(I) = 0.D0
      DO 70  I=1,12
   70 ICC(I)= 0
      DO 80 I = 1,4
   80 RANDS(I) = RANDI(I)
      PM(1) = DNCMS
      GO TO(110,110,100,90,100,90,90),ITYP
C           P  N  PI+ PI0 PI- MU+ MU-
   90 CALL CERROR('CPCOL1$')
      WRITE(IO,10000) ITYP
10000 FORMAT(' Wrong particle type = ',I2,' in CPCOL')
  100 PM(1) = PNMS
  110 INC =1
      CLSM = 1.D0
      PM(2) = DNCMS
      E(2) = DNCMS
      E(1) = DBLE(EC)*RCPMV + PM(1)
      PXYZ(2) = 0.
      PXYZ(6) = 0.
      PXYZ(10) = 0.
      CALL P1CLI
C     CALC'S X,Y,Z MOM COORD'S OF INC. PART.(PXYZ(1-5-9))AND P1OE1 = PZ1
      RLKE =(((E(1)*E(2)-PXYZ(1)*PXYZ(2)-PXYZ(5)*PXYZ(6)-PXYZ(9)*PXYZ(10
     +  )) /DNCMS)-PM(1))/RCPMV
      VALUE1 = RANDC(ISEED)
      R = SNGL(VALUE1)
      VALUE1 = RLKE
      ITP = ITYP - ITYP/5
      NOPART = 2
      GO TO (170,170,200,120),ITP
  120 CONTINUE
C    TRY (PI-,P) EXCHANGE.
      R  = R  - XSECHE(4,ITP,EC)/HSIG
      IF( R.GT.0.) GO TO 200
C  A (PI-,P) EXCHANGE EVENT  HAS OCCURRED
      IT = 5
      KIND(1) = 3
C  PI 0
      KIND(2) = 1
C  NEUTRON
      PT(2) = 4.D0
      PT(14) = 2.D0
      IK = IT
      PM(3) = POMS
      IF(RLKE - 340.D0) 130,130,140
  130 CALL CALMUD(SNT,INPT)
      CALL CRDET(51,PMDX,RLKE)
C            DIF PI--P EXCHG
      GO TO 370
  140 I3 = 1
      IF(RLKE-1000.D0) 150,160,160
  150 I3 = 2
      VALUE1 = RLKE - 340.D0
  160 CALL ROUT16(PMDX)
C  DIF PI--P EXCHG 2500-1000, 1000-340,  340- 0
      GO TO 440
  170 CONTINUE
C    TRY NUCLEON - P  DBLE  PRODUCTION.
      IF(EC.LT.ETH(2,ITP)) GO TO 200
      R   = R  -  XSECHE(2,ITP,EC)/HSIG
      IF( R.GT.0. ) GO TO 200
C    DBLE PRODUCTION HAS OCCURRED.
      NOPART =4
      IPPP = 0
  180 NNO = ITYP
      E1NC  = DBLE(EC)
      CALL CISOB
      KNO = 2
      DO 190 NOO = 1,NOPART
         KIND(NOO) = IDINT( DOUT(KNO)) - 1
         EP(NOO) = SNGL ( DOUT(KNO+1))
         ALF(NOO) = SNGL ( DOUT(KNO+4))
         BET(NOO) = SNGL ( DOUT(KNO+5))
         GAM(NOO) = SNGL ( DOUT(KNO+6))
  190 KNO = KNO + 7
      GO TO 310
  200 CONTINUE
C  TRY SNGL PRODUCTION.
      IF(EC .LT. ETH(1,ITP)) GO TO 210
      R  = R -  XSECHE(1,ITP,EC)/HSIG
      IF( R.GT.0.) GO TO 210
C    NUCLEON - P ,PI+ -P, OR PI- -P  SNGL PRODUCTION HAS OCCURRED.
      NOPART =3
      IPPP = -1
      GO TO 180
  210 CONTINUE
C  AN ELASTIC EVENT HAS OCCURRED.
      GO TO (230,240,340,220,390,220,220),ITYP
  220 CALL CERROR('CPCOL2$')
      WRITE(IO,10100) ITYP
10100 FORMAT(' Wrong particle type = ',I2,' in CPCOL ')
  230 I3 =7
      IT =18
      GO TO 250
  240 I3 = 4
      IT = 15
  250 CALL ROUT20(DCIN(1),DCLN(1),DCHN(1),PDCI(1),PDCH(1))
C ELAS DIF XSECTS-NP 300-740,NP 0-300, NP 660-3500, PP 500-1000,PP 660-3
C     SETS PT(2)=1.-PROT,2.-NEUT,PT(14)=1.,PM(3)= DNCMS
C     CALC'S CST(SCAT COS) FOR EC GT (500 FOR PROT,740 FOR NEUTS)
      I3 = I3
      IGO = I3-4
      GO TO (330 ,260 ,270 ,280 ),IGO
C      I3 =   5    6    7    8
  260 SNT = DSQRT(1.D0 - CST*CST)
      GO TO 280
  270 CALL CAPOL1(CST,SNT)
  280 CALL CESWH
  290 IF(IT.EQ.5) GO TO 300
      KIND(1) = ITYP - 1
      KIND(2) = 0
C    PROTON
  300 CONTINUE
      EP(1)= SNGL( PT(3) )
      ALF(1)=SNGL( PT(8) )
      BET(1)=SNGL( PT(9) )
      GAM(1)=SNGL( PT(10))
      EP(2)= SNGL( PT(15))
      ALF(2)=SNGL( PT(20))
      BET(2)=SNGL( PT(21))
      GAM(2)=SNGL( PT(22))
  310 DO 320  I = 2,4
  320 RANDI(I) = RANDS(I)
      RETURN
  330 I3=4
      CALL ROUT15(PPDC(1))
C      CALC'S CST(SCAT COS) FOR EC LT 740 MEV
      GO TO 260
  340 I3 =1
      IT =1
C     PI+-P ELAS
  350 CALL ROUT11(PPDC (1))
C  TAPCRS(248)  PI+-P  LT 340 MEV.
      I3 = I3
      GO TO (380,360,360,370),I3
  360 CALL CERROR('CPCOL3$')
      WRITE(IO,10200) I3
10200 FORMAT(' I3 = ',I3,' IN CPCOL')
  370 CST = CRDT(2)- DABS(SNT*(CRDT(2)-CRDT(1)))
      GO TO 260
  380 I3 =1
      CALL ROUT15(PPDC(1))
C   PI+-P DIF ELAS FOR1.-2.5 GEV AT 3401,FOR .34 -1. AT 3231.
      I3 = I3
      GO TO 260
  390 IT= 3
C   PI--P ELAS
      I3= 2
      PT(2) = 5.D0
      PT(14)= 1.D0
      IK= IT
      PM(3) = PNMS
      IF(RLKE - 340.D0) 400,400,410
  400 CALL CALMUD(SNT,INPT)
      CALL CRDET(51,PMDD(1),RLKE)
      GO TO 370
  410 I3 =1
      IF(RLKE - 1000.D0) 420,430,430
  420 I3 = 2
      VALUE1 = RLKE - 340.D0
  430 CALL ROUT16(PMDD(1))
  440 I3 = I3
      IF( I3) 260,450,460
  450 I3 = 3
      CALL ROUT15(PPDC(1))
      GO TO 260
  460 CONTINUE
      GO TO 360
      END
