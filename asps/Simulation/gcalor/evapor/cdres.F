* $Id: cdres.F,v 1.1.1.1 2004/01/15 00:08:47 potekhin Exp $
* $Name:  $
#include <commons/config.h>
      SUBROUTINE CDRES(M2,M3,T1,NPART,EPART,SOCHPE,U,EREC,HEPART)
C*****A LA EVAP III(TWA,8-68)
C*****COMPATIBLE WITH O5R DRES EXCEPT FOR COMMON/COMON/
C
#include "gcalor/cjoint.inc"
#include "geant321/crandm.inc"
#include "gcalor/cforcn.inc"
#include "gcalor/cdresc.inc"
#include "gcalor/cevcm.inc"
#include "geant321/camass.inc"
      LOGICAL INIT
C
C
      DIMENSION ZMASS(6),Q(6) ,
     +          FLKCOU(6) ,CCOUL(6) ,THRESH(6) , NPART(6),
     +          EPART(200,2) ,HEPART(200,4) ,SMALLA(6) ,
     +          R(6) ,S(6) ,SOS(6) ,STRUN(6) ,EYE1(6) ,EYE0(6) ,
     +          SMOM1(6) ,IAI(5) ,IZI(5) ,XX(5)
C
      SAVE
      DATA INIT/.TRUE./
C
CZ      DELTAS (A)=(A-1.0)/(1.0+(124.0/A**0.6666667))
      IF(.NOT.INIT) GO TO 20
      INIT = .FALSE.
      FKEY=0.
C evaporation data read in by CRBERT called by CALINI CZ 19.JUNE 92
      DO10 K=1,7
   10 T(4,K)=0.0
      Y0=1.5
      B0=8.0
      NBE8 = 0
      NRNEEP = 0
      ZMASS(1) = XMASS(1)*1.E3
      ZMASS(2) = XMASS(0)*1.E3
      ZMASS(3) = XMASS(7)*1.E3
      ZMASS(4) = XMASS(8)*1.E3
      ZMASS(5) = XMASS(9)*1.E3
      ZMASS(6) = XMASS(10)*1.E3
      EMH = ZMASS(2)
      EMN = ZMASS(1)
C      QUESTION:WHAT IS UM?
C       END OF CHANGE
      UM = 931.20793
      EMHN=EMH-EMN
      EMNUM=EMN-UM
   20 CONTINUE
      DO30 I=1,6
         NPART(I)=0
   30 SMOM1(I)=0.0
      DO40  K=1,6
         FLA(K)=IA(K)
   40 FLZ(K)=IZ(K)
   50 JA=M2
      JZ=M3
      U=T1
      IF(JA-JZ)60  ,60  ,70
   60 CONTINUE
#if defined(ATLAS_CDEBUG)
      WRITE(6,10000) JA,JZ
10000 FORMAT(' CASCADE RESIDUAL NUCLEUS HAS MASS NO. LESS THAN OR E
     +QUAL TO Z ','A=',I5,' Z=',I5)
#endif
      RETURN
   70 A=JA
      Z=JZ
      BE=Z*EMHN+A*EMNUM-CENERG(A,Z)
      RNMASS=Z*EMH+(A-Z)*EMN-BE
      IF(EREC)80  ,80  ,90
   80 VRNSQ=0.
      VCM=0.
      GO TO 100
   90 VRNSQ=2.0*EREC/RNMASS
      VCM=SQRT(VRNSQ)
  100 IF(JA-8)120 ,110 ,120
  110 IF(JZ-4)120 ,710 ,120
  120 CONTINUE
      DO150 K=1,6
         IF((A-FLA(K)).LE.(Z-FLZ(K)))GO TO 150
         IF(A-2.0*FLA(K))150,130,130
  130    IF(Z-2.0*FLZ(K))150,140,140
  140    Q(K) = CQNRG(A-FLA(K),Z-FLZ(K),A,Z) + EXMASS(K)
C 728 Q(K)=CENERG(A-FLA(K),Z-FLZ(K))-CENERG(A,Z)+EXMASS(K)
  150 CONTINUE
      FLKCOU(1)=0.0
      FLKCOU(2)=CDOST(1,Z-FLZ(2))
      FLKCOU(3)=FLKCOU(2)+.06
      FLKCOU(4)=FLKCOU(2)+.12
      FLKCOU(6)=CDOST(2,Z-FLZ(6))
      FLKCOU(5)=FLKCOU(6)-.06
      CCOUL(1)=1.0
      CCOU2=CDOST(3,Z-FLZ(2))
      CCOUL(2)=CCOU2+1.0
      CCOUL(3)=CCOU2*1.5+3.0
      CCOUL(4)=CCOU2+3.0
      CCOUL(6)=CDOST(4,Z-FLZ(6))*2.0+2.0
      CCOUL(5)=2.0*CCOUL(6)-1.0
      SIGMA=0.0
      DO200 J=1,6
         IF(A-2.0*FLA(J))180,160,160
  160    IF(Z-2.0*FLZ(J))180,170,170
  170    MM=JA-IA(J)
         ZZ=Z-FLZ(J)
         AA=A-FLA(J)
         IF(AA.LE.ZZ)GO TO 180
         SMALLA(J)=AA*(1.0+Y0*(AA-2.0*ZZ)**2/AA**2)/B0
         THRESH(J)=Q(J)+.88235*FLKCOU(J)*FLZ(J)* ZZ/(RMASS(MM)+RHO(J))
         NN=AA-ZZ
         IZZ=ZZ
         CORR=CAM4(IZZ)+CAM5(NN)
         IF(FKEY.EQ.1.) CORR=0.
         ARG=U-THRESH(J)-CORR
         IF(ARG)180,190,190
  180    R(J)=0.0
         S(J)=0.0
         SOS(J)=0.
         GOTO200
  190    S(J)=SQRT (SMALLA(J)*ARG)*2.0
         SOS(J)=10.0*S(J)
  200 CONTINUE
      N1=1
      DO210 J=1,6
         IF(SOS(J)-1250.0)210 ,220 ,220
  210 CONTINUE
      N1=2
      GO TO 230
  220 SES=AMAX1(S(1),S(2),S(3),S(4),S(5),S(6))
  230 DO390 J=1,6
         IF(S(J))240 ,390 ,240
  240    JS=SOS(J)+1.0
         MM=JA-IA(J)
         IF(N1-1)250 ,260 ,250
  250    IF(JS-1000)290 ,270 ,270
  260    SAS=EXP (S(J)-SES)
         GO TO 280
  270    SAS=EXP (S(J)-50.0)
  280    EYE1(J)=(S(J)**2-3.0*S(J)+3.0)*SAS/(4.0*SMALLA(J)**2)
         FJS=JS
         STRUN(J)=FJS-1.0
         GO TO 300
  290    FJS=JS
         STRUN(J)=FJS-1.0
         EYE1(J)=(P1(JS)+(P1(JS+1)-P1(JS))*(SOS(J)-STRUN(J)))/ SMALLA(J
     +   )**2
  300    IF(J-1)320,320,310
  310    R(J)=CCOUL(J)*RMASS(MM)**2*EYE1(J)
         GOTO380
  320    IF(N1-1)330 ,340 ,330
  330    IF(JS-1000)350 ,340 ,340
  340    EYE0(J)=(S(J)-1.0)*0.5*SAS/SMALLA(J)
         GO TO 360
  350    EYE0(J)=(P0(JS)+(P0(JS+1)-P0(JS))*(SOS(J)-STRUN(J))) /
     +   SMALLA(J)
  360    R(J)=RMASS(MM)**2*ALPH(MM)*(EYE1(J)+BET(MM)* EYE0(J))
         IF(R(J))370 ,380,380
  370    R(J)=0.0
  380    SIGMA=SIGMA+R(J)
  390 CONTINUE
      NCOUNT = 0
  400 IF(SIGMA)410,410,500
  410 CONTINUE
      DO 430  J = 1,6
         IF(JA-IA(J))430 ,420 ,430
  420    IF(JZ-IZ(J))430 ,440 ,430
  430 CONTINUE
      GO TO 480
  440 JEMISS = J
C*****STORE,RESIDUAL NUC IS OF EMITTED PARTICLE TYPE
      EPS = U + EREC
      NPART(JEMISS) = NPART(JEMISS)+1
      NRNEEP = NRNEEP + 1
  450 SMOM1(JEMISS) = SMOM1(JEMISS) + EPS
      IF(JEMISS-2)460 ,460 ,470
  460 EPART(NPART(JEMISS),JEMISS)=EPS
      GO TO 780
  470 KEMISS=JEMISS-2
      HEPART(NPART(JEMISS),KEMISS)=EPS
      GO TO 780
  480 IF(JA-8)790,490,790
  490 IF(JZ-4)790,710,790
  500 URAN = RANDC(ISEED) * SIGMA
      SUM=0.0
      DO510 J=1,6
         K=J
         SUM=R(J)+SUM
         IF(SUM -URAN)510,510,520
  510 CONTINUE
  520 JEMISS=K
      JS=SOS(JEMISS)+1.0
      IF(JS-1000)540 ,530 ,530
  530 RATIO2=(S(JEMISS)**3-6.0*S(JEMISS)**2+15.0*
     +S(JEMISS)-15.0)/((2.0*S(JEMISS)**2-6.0*S(JEMISS)+6.0)*SMALLA
     +(JEMISS))
      GO TO 550
  540 RATIO2=(P22(JS)+(P22(JS+1)-P22(JS))*
     +(SOS(JEMISS)-STRUN(JEMISS)))/SMALLA(JEMISS)
  550 EPSAV=RATIO2*2.0
      IF(JEMISS-1)560,560,580
  560 MM=JA-IA(J)
  570 EPSAV=(EPSAV+BET(MM))/(1.0+BET(MM)*EYE0(JEMISS)
     +/EYE1(JEMISS))
  580 E1=EXPRNF(V)/2.0
      E2=EXPRNF(V)/2.0
      EPS=(E1+E2)*EPSAV+THRESH(JEMISS)-Q(JEMISS)
      COSCM = RANDC(ISEED)
      PLORMI = RANDC(ISEED)
      IF(PLORMI-0.5)590,590,600
  590 COSCM=-COSCM
  600 AR=A-FLOAT (IA(JEMISS))
      ZR=Z-FLOAT (IZ(JEMISS))
      BE=ZR*EMHN+AR*EMNUM-CENERG(AR,ZR)
      RNMASS=ZR*EMH+(AR-ZR)*EMN-BE
      VCMEPS = 2.0*EPS/(ZMASS(JEMISS)*(1.+ZMASS(JEMISS)/RNMASS))
      VCMEVP=SQRT(VCMEPS)
      VRNSQ=VCMEPS*ZMASS(JEMISS)*ZMASS(JEMISS)/(RNMASS*RNMASS)
     ++VCM*VCM+2.0*ZMASS(JEMISS)/RNMASS*VCMEVP*VCM*COSCM
      VLBEPS=VCMEPS+VCM*VCM-2.*VCMEVP*VCM*COSCM
      EPS=0.5*ZMASS(JEMISS)*VLBEPS
  610 UNEW=U-0.5*VCMEPS*(ZMASS(JEMISS)*ZMASS(JEMISS)/RNMASS+ZMASS(JEMISS
     +))-Q(JEMISS)
      IF(UNEW)630 ,620 ,620
  620 U = UNEW
      VCM=SQRT(VRNSQ)
      EREC=0.5*RNMASS*VRNSQ
      NPART(JEMISS)=NPART(JEMISS)+1
      GO TO 650
  630 NCOUNT = NCOUNT + 1
      IF(NCOUNT-10) 580,580,640
  640 SIGMA = SIGMA - R(JEMISS)
      R(JEMISS) = 0.0
      NCOUNT = 0
      GO TO 400
  650 JAT=JA-IA(JEMISS)
      JZT=JZ-IZ(JEMISS)
      IF(JAT-JZT)410,410,660
  660 JA=JAT
      JZ=JZT
C*****STORE,END OF NORMAL CYCLE
      SMOM1(JEMISS)=SMOM1(JEMISS)+EPS
      IF(NPART(JEMISS).LE.0)CALL CERROR('CDRES1$')
      IF(JEMISS-2)670 ,670 ,680
  670 EPART(NPART(JEMISS),JEMISS)=EPS
      GO TO 690
  680 KEMISS=JEMISS-2
      HEPART(NPART(JEMISS),KEMISS)=EPS
  690 IF(JA-8)70,700 ,70
  700 IF(JZ-4)70,710 ,70
  710 IF(U)720 ,720 ,730
  720 EPS=0.
      GO TO 740
  730 EPS=0.5*(U+.093)
  740 NBE8=NBE8+1
      COSCM = RANDC(ISEED)
      VCMEPS=2.0*EPS/ZMASS(6)
      VCMEVP=SQRT(VCMEPS)
      VLBEPS=VCMEPS+VRNSQ+2.0*VCMEVP*VCM*COSCM
      NOP=0
  750 EPS=0.5*ZMASS(6)*VLBEPS
C*****STORE,BE 8 BREAKUP
      SMOM1(6)=SMOM1(6)+EPS
      NPART(6)=NPART(6)+1
      HEPART(NPART(6),4)=EPS
      IF(NOP)760,760,770
  760 VLBEPS=VCMEPS+VRNSQ-2.0*VCMEVP*VCM*COSCM
      NOP=1
      GO TO 750
  770 CONTINUE
  780 EREC=0.
      U = 0.0
  790 SOCHPE=SMOM1(3)+SMOM1(5)+SMOM1(6)+SMOM1(4)
  800 CONTINUE
      RETURN
      END
