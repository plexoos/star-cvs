#!/opt/star/bin/perl
Import qw ( env INCLUDE LIB BIN  EXPORT BUILD OBJ);
(my $build = $OBJ) =~ s/\#//g;
$build =~ s/\\/\//g;
(my $ObjDir = DirPath '.') =~ s/\\/\//g;
(my $Dir = $ObjDir) =~ s/$build\///g;
$ObjDir = "#" . $ObjDir; 
(my $obj_dir = $ObjDir) =~ s/^\#//g;
my $STAR_SYS = $env->{ENV}->{STAR_SYS};
my $pkg  = root4star;
my @GDIRS = qw(.
	       ../agi/gst/agsim
	       ../agi/gst/geant
	       ../agi/gst/zebra
	       ../agi/gst/dzdoc
	      );

my $PKG  = $pkg . $env->{SUFEXE};
my $SO_PKG = $PKG . "." . $env->{SUFSOLIB};
my $LIBPKG = $PKG . "." . $env->{SUFLIB};
my @h_files = find_hfiles($Dir);
$CPPPATH = "#asps/agi:#asps/agi/gst:" . $env->{CPPPATH};
$CPPFLAGS = $env->{CPPFLAGS} . " -DCERNLIB_DZDOC -DCERNLIB_NONEWL -DCERNLIB_SHL -DCERNLIB_HADRON -DCERNLIB_BSLASH -DCERNLIB_HIGZ -DCERNLIB_CG";
if ($STAR_SYS =~ /egcs$/) {$CPPFLAGS .= " -DPrivateMalloc";}
print "build $pkg with cons\n";
(my $share = $EXPORT .  "/" . $Dir) =~ s/\/asps//g; 
my $CXXFLAGS = $env->{CXXFLAGS};
my $LIBPATH = $env->{ENV}->{ROOTSYS} . "/lib:" . $env->{LIBPATH};
my $LIBS  = $env->{ROOTLIBS} . " " . $env->{ROOTGLIBS} . " " . $env->{RINTLIBS} . " " . $env->{LIBS};
   $LIBS .= " -lSTAR -lStar2Root";
my $Libraries =  $env->{Libraries};
if ($STAR_SYS =~ /^sun4x_5.$/) {$CXXFLAGS .= " -ptr" . $obj_dir;}
$env2 = $env->clone('CPPPATH'      => $CPPPATH,
		    'CPPFLAGS'     => $CPPFLAGS,
		    'CXXFLAGS'     => $CXXFLAGS,
		    'LIBPATH'      => $LIBPATH,
		    'LIBS'         => $LIBS,
		    'Libraries'    => $Libraries
		   );
my @src = ();
foreach my $d (@GDIRS){
  my $dir = $Dir . "/" . $d;
  my @sources  = find_sources($dir);
  foreach my $s (@sources) {
    my $ss = $d . "/" . $s;
    next if $ss =~ /\/gst\/agsim\/agdummy\.g/ or $ss =~ /traceqc/ or $ss =~ /ighcxy/;
    push @src, $ss; 
  }
}
foreach my $cpp (@cpps,$Dir) {
  if ($cpp =~ /cern/ ||
      $cpp eq "/usr/include"
     )  {next;}
  if ($ROOTCINT_CPP) {$ROOTCINT_CPP .= ":" . $cpp;}
  else               {$ROOTCINT_CPP .= $cpp;}
}
$cscanner= find scan::cpp($env2->{_cwd}, $ROOTCINT_CPP);
my $ROOTCINT_CPPPATH = $cscanner->iflags;
my $DIR = cwd(); 
my $line;
my @Defs = ();
if ($Dir !~ /pams\//) {
  foreach $h (@h_files) {
    if ($h =~ /LinkDef/ || $h =~ /Stypes/) {push @Defs, $h; next;}
    my $hh = $Dir . "/" . $h;
    if (-r $hh) {
      open (In,$hh) or die "Can't open $hh";
      while ($line = <In>) {if ($line =~/ClassDef/ || $line =~ /StCollectionDef/) {push @Defs, $h; goto ENDL;}}
      close(In);
    }
    else {      
      foreach my $Rep (@Repo) {
	my $RepDir = $Rep . "/" . $Dir;
	if (-d $RepDir) {
	  my $hh = $RepDir . "/" . $h;
	  if (-r $hh) {
	    open (In,$hh) or die "Can't open $hh";
	    while ($line = <In>) {if ($line =~/ClassDef/ || $line =~ /StCollectionDef/) {push @Defs, $h; goto ENDL;}}
	    close(In);
	  }
	}
      }
    }
  ENDL:
  }
}
if ($#Defs > -1) {
  Install $env2 $INCLUDE, @Defs;
  my @CintFiles = 
  ($share . "/"  . $PKG . "_Cint.cxx", $share . "/"  . $PKG . "_Cint.h");
  my @defs = ();
  my @d    = ();
  foreach my $def (@Defs) {
    push @defs, $share . "/" . basename($def); 
    push @d   , "#include/" .  basename($def); 
  }
  Install $env2 $share, @d;
  Command $env2 [@CintFiles], @defs,  qq(RootCint.pl "%>" "%<" "$ROOTCINT_CPPPATH" );
  Install $env2 $ObjDir, @CintFiles;
  (my $cint =  $CintFiles[0]) =~ s/$share/$ObjDir/g;
  push @src, $cint; 
}

if ($#src > -1) {
  Program      $env2 $pkg, @src;
  Install $env2 $BIN, $pkg;
}  
