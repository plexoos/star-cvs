#include <algorithm>
using namespace std;

#include "bits.hh"
#include "Board.hh"
#include "qt32b_fms_2015_a.hh"
#include <stdio.h>

#include "registerHack.hh"

void qt32b_fms_2015_a(Board& qt)
{
  int HTthr0,HTthr1;  
  //HACK, until we get details for label
  char n[5];
  int qtaddr; 
  sscanf(qt.name,"%4s%x",n,&qtaddr);
  //printf("QTAddress=%02x for %s\n",qtaddr,qt.name);
  if(qtaddr<0x14) { HTthr0=Sm_HTthr0;  HTthr1=Sm_HTthr1; }
  else            { HTthr0=Lg_HTthr0;  HTthr1=Lg_HTthr1; }

  qt.output = 0;
  int sum[2]={0, 0};
  for (int i=0; i<2; i++) { //AB sum and CD sum
    for (int j = 0; j<16; j++) {
      int id = i*16 + j;
      int adc = qt.channels[id];
      //fake data
      //adc = 4095;
      sum[i] += adc;
    }
    if(sum[i] > 0xfff) sum[i] = 0xfff;
  }

  qt.output |= sum[0];
  qt.output |= sum[1]<<12;
  
  if(htadc>0)
    printf("%s=%08x sum=%4d %4d\n",
	   qt.name,qt.output,getQT01Sum(qt.output),getQT23Sum(qt.output));
}

int getQT01Sum(int qtout){return getbits(qtout, 0,12);}
int getQT23Sum(int qtout){return getbits(qtout,12,12);}
