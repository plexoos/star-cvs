<html>
<title>STAR logger</title>
<body>
<b><pre>

     ***************************************************************
     ***************************************************************
     ****                    STAR logger:                       ****  
     ****     The STAR offline logger-based message manager     ****
     ***************************************************************
     ***************************************************************
</pre></b>
STAR logger is a the logger-based implementation of <a href="http://www.star.bnl.gov/STAR/comp/sofi/StMessMgr">
STAR message manager interface</a>

<p>
Table of Contents:
<ul>
<li><a href="#logger">Integration log4j package for STAR framework</a>
<li><a href="#makers">Logger for STAR Makers</a>
<li><a href="#macros">New macros</a>
<li><a href="#use">How to use</a>
<li><a href="#conf">How to configure</a>
<li><a href="#print">"Print statement" transition</a>
<li><a href="#examples">"Examples (under construction yet)"</a>
</ul>
<a name="#logger"></a>
<h2> Integration log4j package for STAR framework</h2>


  Integration of the <a href="http://logging.apache.org">log4j</a> packages and STAR offline framework 
  was straightforward due to an already existing OO  
  <a href="http://www.star.bnl.gov/STAR/comp/sofi/StMessMgr">design</a> 
  for processing message streams. For the STAR C++ production code  the 
  <a href="http://logging.apache.org/log4cxx">C++ version</a> of the logger, 
  so-called <a href="http://logging.apache.org/log4cxx">log4cxx</a> 
  was chosen.
  
<p>
  Most (if not all) components of the STAR production 
  framework send their log messages to the abstract STAR messenger. 
  To merge the STAR existing framework with the log4j package, 
  it was only a matter of creating another implementation of 
  the STAR messenger interface. Additionally, and to meet 
  the STAR production needs, a standard set of the logger 
  appender and filter features were either developed or enhanced. 
  We added one extra appender to communicate with the STAR 
  production MySQL database and created a custom logger filter 
  to be able to select/suspend the messages according to the 
  STAR production manager's criteria. Once again, and due to 
  the already existing OO messenger implementation in the 
  STAR production system, enabling the new scheme did not 
  require modifying any existing piece of the STAR code. 
  It was sufficient to dynamically load the new implementation 
  and provide an external XML <a href="#conf">configuration file</a> 
  for the logger as needed. 

<a name="#makers"></a>
<h2> "Loggers" for STAR Makers  </h2>

  With the new implementation, the STAR framework initiates two common loggers: <b><code>"BFC"</code></b> 
  and <b><code>"QA"</code></b> and each STAR StMaker subclass instantiates 
  its own logger. The logger name is the subclass class name.
  This allows to set the logger list of appenders, filters and level of 
  the severity for entire production chain or / and for each STAR maker subclass separately.
  The end user code is not to worry about the proper selection of the appropriated logger.
  The user via set of the CPP <a href="#macros">macro</a> or 
  via the <a href="http://www.star.bnl.gov/STAR/comp/sofi/StMessMgr#i1"><code>gMessMgr</code> 
  global pointer</a>
  communicate with the so-called "current logger".
   The base StMaker class internally governs the logger selection to make sure the current
  logger  matches the logger of the current active StMaker instance.

<a name="#macros"></a>
<h2> New macros </h2>

The base STAR message manager abstract interface was improved to provide better performance.
It is recommended now instead of direct use of the Messager global pointer apply the CPP macros
 as follows:
 
<ul>    
  <li> <b><code>LOG_INFO</code></a> </b>
  <li> <b><code>LOG_WARN</code></a> </b>
  <li> <b><code>LOG_ERROR</code></a> </b>
  <li> <b><code>LOG_FATAL</code></a> </b>
  <li> <b><code>LOG_DEBUG</code></a> </b>
  <li> <b><code>LOG_QA</code></a> </b>
</ul>
are followed by the C++ output "stream" elements  and ended up with the <b><code>"endm"</code></b> object.
For example, to direct the message to the "error" logger on needs:

<b><code> <pre>
  LOG_ERROR << "My error message" << endm;
</pre>  </code> </b>

<a name="#use"></a>
<h2> How to use the manager </h2>

To use the STAR message manager your code has to contain the STAR message manager 
<a href="http://www.star.bnl.gov/cgi-bin/cvsweb.cgi/StRoot/St_base/StMessMgr.h">interface header file</a>:

  <b><code>
   <pre>
    #include "StMessMgr.h" 
  </pre>
   </code></b>
  and use that interface <a href="#macros">CPP macros</a>

<P>
 By default STAR "root4star" framework works with the old STAR message manager implementation.

<p>
  To turn the new one one should load the extra shared library.
  The ROOT macros <a href="http://www.star.bnl.gov/cgi-bin/cvsweb.cgi/StRoot/macros/LoadLogger.C"><b><code>LoadLogger.C</code></b></a> does just that.
  This means to instantiate the new logger it is enough to call <a href="http://www.star.bnl.gov/cgi-bin/cvsweb.cgi/StRoot/macros/LoadLogger.C"><b><code>"LoadLogger.C"</code></b></a>
  followed by you your ROOT macro invocation. 
  <p>
   For example to get BFC.C works with the new logger schema one needs to start the "root4star" session and call TWO macros:
   <b><code>
   <pre>
     &gt;root4star
     root4star[0] .x LoadLogger.C
     root4star[0] .x Bfc.C(1, . . . )
   </pre>
   </code></b>
 <p>
   As soon as the new logger is loaded the output files, format and level of 
   the verbosity may be defined by the external Logger configuration file.
   It recommended to avoid using any method of the STAR message manager describing with 
   <a href="http://www.star.bnl.gov/STAR/comp/sofi/StMessMgr"> document</a> and use <a href"#macros">the macros</a>
   mentioned above only. This is to make the ocde free of the run-time and compilation 
   time parameters this can be defined via the <a href="#conf">logger configuration</a> file.
 <p>
   
   In other words the author of the code should not apply the "Advanced methods" described by   
   <a href="http://www.star.bnl.gov/STAR/comp/sofi/StMessMgr"> "Section II"</a> 
   from the use code as soon as this can be done outside of the code at run-time.
 <p>
   It is enough to define the desirable messages and its level. 
   All other features can be ordered with the configuration 
   file at run-time without any needs to change and re-compile the code.
<a name="#conf"></a>
<h2>How to configure</h2>

<a name="#file"></a>
To overwrite the STAR default output logger configuration one can provide 
the custom configuration with the 
<b><code>"log4j.xml"</code></b> file in the current working directory.

<a name="#env"></a>
One can alternate the default configuration file name and its location via <b><code>STAR_LOGGER_PROPERTY</code></b>
environment variable.
<p>
<a name="#fileExample"></a>
For example, <a href="http://www.star.bnl.gov/cgi-bin/cvsweb.cgi/StRoot/StStarLogger/log4j.xml">the file <b><code>"log4j.xml</code></b></a> 
defines the "Console output" for entire STAR production chain and the <b><code>"Debug"</code></b> level of the messages.

<p>

"Jakarta log4j" is a community-supported project that includes the log4cxx,
 log4c, and log4perl packages (thereby supporting multiple computing languages) 
 
 The output media and format and level are configured by providing the set of the different parameters
 via the external configuration file 
 (of course we do provide the reasonable default. If one is happy with that no extra file is required).
 For all STAR StMaker subclass at once or /and for each separate subclass
 one may define the desirable output by combining 4 different logger components:
 
<ul>
<li>	<a href="http://logging.apache.org/log4cxx/manual/Introduction.html#LoggersAppendersAndLayouts">loggers</a>
<li>	<a href="http://logging.apache.org/log4cxx/manual/Introduction.html#AppendersAndLayouts">appenders</a>
<li>	<a href="http://logging.apache.org/log4cxx/manual/Introduction.html#AppendersAndLayouts">layouts</a>
<li>	<a href="http://logging.apache.org/log4cxx/manual/classlog4cxx_1_1spi_1_1Filter.html">filters</a>
</ul>

These four types are necessary to empower the developers with the capabilities 
to log messages according to message type and level, to control at runtime 
how these messages are formatted, and lastly to decide where they are reported. 
<p>
For each logger one can define the"priority value" (message level) and the arbitrary number of the different appenders.
For each appender one can specify one layout if any  and arbitrary number of the filters.
<p>

The C++ version of the package provide the ready-to-eat components to choose from:
See: <a href="http://logging.apache.org/log4cxx/">http://logging.apache.org/log4cxx</a>
<p>
The layout may be supplied with the custom format string.

<a name=#formats"></a>
   <b><code>
   <pre>
  Formats:
     %c  - logger name %c{2} = b.c  ( a.b.c. )
     %d  - date        %d{%H:%M:%S} or %d{%d %b %Y %H:%M:%S}. 
                        a - short week date name, A - full week date name
                        b - short month name,     B - full month name  m - month number (1-12)
                        d - day of the month
                        H - hours (0-23)          I - hours ( 1 - 12)
     %F  - the file name where the logging request was issued
     %l  - location information of the caller which generated the logging event
     %L  - the line number from where the logging request was issued
   </pre>
   </code></b>
   <b><i><code>
   <pre>
     %m  - the application (user) supplied message associated with the logging event
   </pre>
   </code></i></b>
   <b><code>
   <pre>
     %n  - the platform dependent line separator character or characters ("newline" symbol)
     %p  - the level(priority) of the logging event
     %r  - the number of milliseconds elapsed since the start 
     %x  - the NDC (nested diagnostic context) 
   </pre>
   </code></b>


"By default" STAR message manager uses the "pattern layout" with the format:
   <b><code>
   <pre>
        PatternLayout("%-3c{2}:%-5p - %m%n"));
   </pre>
   </code></b>

According the format and layout that prints out:
<ul>
  <li> <b><code>"%-3c{2}"</code></b> - the current STAR "StMaker" class name within 3 symbols field
  <li> <b><code>":"</code></b>  - the symbol ":" 
  <li> <b><code>"%-3p"</code></b>  - the current level (defined for example by <a href="#macros">the macro applied</a>) of the message within the 5 symbols field 
  <li> <b><code>" - "</code></b> - 3 symbols: blank, dash, blank
  <li> <b><code>"%m"</code></b> - the user provided message (via CPP <a href="#macros">macros</a> within 30 letters at most field 
  <li> <b><code>"%n"</code></b>  - the "end-of-line" symbol
</ul>
<p>
Examples:

   <b><code>
   <pre>
      QA :INFO  - Output root file name gtrack.root
   </pre>
   </code></b>


   <b><code>
   <pre>
      BFC:INFO  - StTpcDbMaker::Using any drift velocity
   </pre>
   </code></b>

   <b><code>
   <pre>
      BFC:WARN  -  Validity:19980101/0  -----   20010710/5436
   </pre>
   </code></b>
<p>
  
<a name="#print"></a>
<h2> "Print statement" transition</h2>
 To enjoy the new logger feature one should replace the "regular" C++ I/O stream output statement or C output function  with that calling the loggers.
This transition is simple and straightforward.
<p>
<a name="#printCplus"></a>
<h3> "C++" output stream statements </h3>
If you use the C++ output streams like <b><code>"cout"</code></b>, <b><code>"cerr"</code></b>  to get an access to the logger it is enough to 
<ul>
<li> replace the <b><code>"cout"</code></b> and <b><code>"cerr"</code></b> object with the appropriated <a href="#macros">logger macros</a>
and 
<li>replace the <b><code>"endl"</code></b> object with <b><code>"endm"</code></b> ones.
</ul>

For example, replace of your plain C++ statement:
   <b><code>
   <pre>
          cout << "DbFill: structure: " << structName << endl;
   </pre>
   </code></b>

with
   <b><code>
   <pre>
      LOG_INFO << "DbFill: structure: " << structName << endm;
   </pre>
   </code></b>
<a name="#printCprintf"></a>
<h3> "C"output subroutines</h3>

One advises the <a href="http://root.cern.ch/root/htmldoc/TString.html#TString:Form">"Form"</a> ROOT method 
simplify the transition the programs those contain the C-language output subroutines like <b><code>"printf"</code></b> or <b><code>"fprintf"</code></b>.

You may add the appropriated  <a href="#macros">logger macros</a> followed by the former <b><code>printf</code></b> statement 
followed by <b><code>"endm"</code></b> object and 
semicolon and replace the name of the C subrotuine (for example printf) 
with the Form method.
Don't forget to remove the end-of-line symbol ( <b><code>"\n"</code></b>
) from the format string.
<p>
For example, to enable "logger", the line
   <b><code>
   <pre>
   printf(" %d pre and %d post crossing data available\n",numberOfPreXing(),numberOfPostXing());
   </pre>
   </code></b>
may be replaced with
   <b><code>
   <pre>
  LOG_DEBUG <<
     Form(" %d pre and %d post crossing data available",numberOfPreXing(),numberOfPostXing())
            << endm;
   </pre>
   </code></b>

<a name="#examples"></a>
<H2>"Examples (under construction yet)"</H2>

<hr>
<small>
Webmaster: <a href="mailto:fine@bnl.gov">Valeri Fine</a>
</small>

</body>
</html>
