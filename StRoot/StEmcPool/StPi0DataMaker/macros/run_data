#!/bin/bash

export myself=${0}
echo myself=$myself
export mypwd=${1}
echo mypwd=$mypwd
export mypwdanalysis=${2}
echo mypwdanalysis=$mypwdanalysis
export mydebug=${3}
echo mydebug=$mydebug
export myscript=${4}
echo myscript=$myscript
export mytag=${5}
echo mytag=$mytag
export myconfig=${6}
echo myconfig=$myconfig
export myscratch=${7}
echo myscratch=$myscratch
export myfilelist=${8}
echo myfilelist=$myfilelist
export myjobid=${9}
echo myjobid=$myjobid
export mydocons=${10}
echo mydocons=$mydocons
export myfilelistsyntax=${11}
echo myfilelistsyntax=$myfilelistsyntax
export mypathout=${12}
echo mypathout=$mypathout
export myjprof=${13}
echo myjprof=$myjprof
export mynevents=${14}
if [[ "$mynevents" == "" ]] ; then export mynevents='-1' ; fi
echo mynevents=$mynevents

cd $myscratch
echo "Running on host "`hostname`

export myscratchanalysis=${myscratch}${mypwdanalysis#$mypwd}

if [[ "$mydocons" == "yes" ]] ; then export COPY_COMPILED='-compiled' ; else COPY_COMPILED='compiled' ; fi

$mypwdanalysis/StPi0Common/macros/copy data $COPY_COMPILED $mypwd $myscratch $mypwdanalysis $myscratchanalysis
$mypwdanalysis/StPi0Common/macros/configure data $myscratchanalysis $myscratch

source $myscratchanalysis/StPi0Common/macros/commands

cp -fr $myfilelist $myscratch/filelist_$myjobid.list

if [[ ( "$STAR_HOST_SYS" == "") || ( ! ( -d $myscratch/.$STAR_HOST_SYS ) ) ]] ; then export mydocons='yes' ; fi

ls -al

if [[ "$mydocons" == "yes" ]] ; then cons ; fi

if [[ "$myfilelistsyntax" == "xrootd" ]] ; then /star/u/starlib/ROOT/xrootd/bin/preStageFileList $myscratch/filelist_$myjobid.list ; fi

if [[ "$myjprof" == "yes" ]] ; then export RUNJPROF='run_jprof.C' ; else export RUNJPROF='' ; fi

run_command $mydebug root4star -q -b load_libs.C load_data_libs.C $RUNJPROF $myscript`bash_escape_all '('${mynevents}',"'${myscratch}'/'${mytag}'_'${myjobid}'.root","'${myscratch}'/filelist_'${myjobid}'.list","'${myconfig}'")'`

mkdir -p $mypathout

copy_file_qa $myscratch/${mytag}_${myjobid}.root $mypathout/${mytag}_${myjobid}.root

if [[ "$myjprof" == "yes" ]]
then
    jprof `which root4star` $myscratch/jprof-log > $myscratch/jprof.html
    copy_file_qa $myscratch/jprof.html $mypathout/${mytag}_${myjobid}.jprof.html
fi

ls -al
