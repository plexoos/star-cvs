#!/bin/bash

#change the following to your own environment
  outDir=/star/data05/scratch/$USER/2005
  outDirlog=$outDir/log

# #############################################################################
# loop over the list of files
runlist=`ezonline | awk '{print $1}' | uniq | grep -v runNumber`
rm filesfor*
mv $outDir/*.root $outDir/DONE/
for line in $runlist ; do
  day=`echo $line | cut -c2-4`
  date=`date '+%j'`
  difference=`expr $date - $day`
  if [ $difference -lt 2 ]
  then
    mudstlist=`ls /star/data08/reco/*/FullField/dev/2005/$day/*$line*MuDst.root`
    for muline in $mudstlist ; do
      echo $muline | awk 'BEGIN{FS="/st_"}{print $1"::st_"$2}' >> filesfor$line
    done
  fi
done
ls filesfor* > CurrentQAfilelist
rm shortlists*
bigfilelist=`ls filesfor*`
ngflfiles=0;
niters=0;
previters=0;
ntwenties=0;
for bigline in $bigfilelist ; do
  filelist=`cat $bigline`
  ngflfiles=`expr 0`
  for line in $filelist ; do 

    ngflfiles=`expr $ngflfiles + 1`
    ntwenties=`expr $ngflfiles / 20`
    niters=`expr $ntwenties + $previters + 1`
    echo "$line" >> shortlists$niters
    echo $ngflfiles,$ntwenties,$niters,$previters
  done
  previters=`expr $niters`
done

#next line just makes the code below pretty - it does not add an iteration!
niters=`expr $niters + 1`

queue=star_cas_big                 
for (( iteration = 1 ; iteration < $niters ; iteration++ )) ; do
#for (( iteration = 1 ; iteration < 3 ; iteration++ )) ; do
  log=log.$iteration
  blog=blog.$iteration
  rm $outDirlog/$log.gz
  rm $outDirlog/$blog
  bsub -R "linux" -q $queue  -J CSM$USER$run -o $outDirlog/$blog   << EOF
    ./StRoot/StEmcPool/CSMStatusUtils/scripts/submitOneRunBatch shortlists$iteration $outDir
EOF
done
sleep 30
bjobsrunning=`bjobs | head -1 | cut -c1-1`
echo $bjobsrunning
while [ $bjobsrunning ]
do
  sleep 600
#  sleep 3
  echo "still sleeping..."
  bjobsrunning=`bjobs | head -1 | cut -c1-1`
  bjobssuspended=`bjobs | grep -v SSUSP | grep -v JOBID | head -1 | cut -c1-1`
  echo $bjobsrunning " is running and " $bjobssuspended " is suspended"
  if [ -z $bjobssuspended ]
  then
    echo "I should not be here"
    bjobsrunning=`bjobs | grep BANANA`
  fi
done
./code/scripts/analysis1
bjobsrunning=`bjobs | head -1 | cut -c1-1`
sleep 30
while [ $bjobsrunning ]
do
  sleep 600
  echo "still sleeping..."
  bjobsrunning=`bjobs | head -1 | cut -c1-1`
  bjobssuspended=`bjobs | grep -v SSUSP | grep -v JOBID | head -1 | cut -c1-1`
  if [ -z $bjobssuspended ] 
  then
    bjobsrunning=`bjobs | grep BANANA`
  fi
done
rm $outDir/6*.root
rm `ls -ltr 2005/*.root | awk '{if($5<10000)print $9}'`
./code/scripts/analysis2
./code/scripts/analysis3
mv shortlists* tmp/.
mv filesfor* tmp/.
