
-include ./Makefile.cfg

ROOT_VER = $(shell root-config --version)
ROOT_EXT = root$(shell root-config --version | cut -d'/' --output-delimiter='.' -f1,2)

ifeq (1$(ANALYSIS_WORKING_DIR),1)
ANALYSIS_WORKING_DIR = .
endif
ifeq (1$(ANALYSIS_DIR),1)
ANALYSIS_DIR = $(ANALYSIS_WORKING_DIR)/StRoot
endif

STPI0COMMON_SRCDIR       = $(ANALYSIS_DIR)/StPi0Common
STPI0ANALYSIS_SRCDIR     = $(ANALYSIS_DIR)/StPi0Analysis
STPI0RESULTS_SRCDIR      = $(ANALYSIS_DIR)/StPi0Results

ifeq (1$(STAR_HOST_SYS),1)
#STAR_HOST_SYS = $(shell root-config --arch)
STAR_HOST_SYS = $(shell bash -c 'source $(STPI0COMMON_SRCDIR)/macros/commands;get_sys')
@echo "Setting system to $STAR_HOST_SYS"
endif

INCDIR = $(ANALYSIS_WORKING_DIR)/StRoot

STPI0COMMON_NAME         = StPi0Common.$(ROOT_EXT)
STPI0ANALYSIS_NAME       = StPi0Analysis.$(ROOT_EXT)
STPI0RESULTS_NAME        = StPi0Results.$(ROOT_EXT)
OUTPUT_DIR            = $(shell pwd)/.$(STAR_HOST_SYS)/lib

.PHONY : all clean distclean print

all:
	mkdir -p $(OUTPUT_DIR)
	@if [[ -e $(STPI0COMMON_SRCDIR) ]] ; then $(MAKE) OUTPUT_DIR=$(OUTPUT_DIR) INCDIR=$(INCDIR) OUTPUT_NAME=$(STPI0COMMON_NAME) -C $(STPI0COMMON_SRCDIR) ; fi
	@if [[ -e $(STPI0ANALYSIS_SRCDIR) ]] ; then $(MAKE) OUTPUT_DIR=$(OUTPUT_DIR) INCDIR=$(INCDIR) OUTPUT_NAME=$(STPI0ANALYSIS_NAME) DATASTRUCTURES_DIR=$(OUTPUT_DIR) DATASTRUCTURES_NAME=$(DATASTRUCTURES_NAME) STPI0COMMON_DIR=$(OUTPUT_DIR) STPI0COMMON_NAME=$(STPI0COMMON_NAME) -C $(STPI0ANALYSIS_SRCDIR) ; fi
	@if [[ -e $(STPI0RESULTS_SRCDIR) ]] ; then $(MAKE) OUTPUT_DIR=$(OUTPUT_DIR) INCDIR=$(INCDIR) OUTPUT_NAME=$(STPI0RESULTS_NAME) STPI0COMMON_DIR=$(OUTPUT_DIR) STPI0COMMON_NAME=$(STPI0COMMON_NAME) STPI0ANALYSIS_DIR=$(OUTPUT_DIR) STPI0ANALYSIS_NAME=$(STPI0ANALYSIS_NAME) -C $(STPI0RESULTS_SRCDIR) ; fi

clean:
	@-if [[ -e $(STPI0COMMON_SRCDIR) ]] ; then $(MAKE) OUTPUT_DIR=$(OUTPUT_DIR) INCDIR=$(INCDIR) OUTPUT_NAME=$(STPI0COMMON_NAME) -C $(STPI0COMMON_SRCDIR) clean ; fi
	@-if [[ -e $(STPI0ANALYSIS_SRCDIR) ]] ; then $(MAKE) OUTPUT_DIR=$(OUTPUT_DIR) INCDIR=$(INCDIR) OUTPUT_NAME=$(STPI0ANALYSIS_NAME) DATASTRUCTURES_DIR=$(OUTPUT_DIR) DATASTRUCTURES_NAME=$(DATASTRUCTURES_NAME) STPI0COMMON_DIR=$(OUTPUT_DIR) STPI0COMMON_NAME=$(STPI0COMMON_NAME) -C $(STPI0ANALYSIS_SRCDIR) clean ; fi
	@-if [[ -e $(STPI0RESULTS_SRCDIR) ]] ; then $(MAKE) OUTPUT_DIR=$(OUTPUT_DIR) INCDIR=$(INCDIR) OUTPUT_NAME=$(STPI0RESULTS_NAME) STPI0COMMON_DIR=$(OUTPUT_DIR) STPI0COMMON_NAME=$(STPI0COMMON_NAME) STPI0ANALYSIS_DIR=$(OUTPUT_DIR) STPI0ANALYSIS_NAME=$(STPI0ANALYSIS_NAME) -C $(STPI0RESULTS_SRCDIR) clean ; fi

distclean:
	@-if [[ -e $(STPI0COMMON_SRCDIR) ]] ; then $(MAKE) OUTPUT_DIR=$(OUTPUT_DIR) INCDIR=$(INCDIR) OUTPUT_NAME=$(STPI0COMMON_NAME) -C $(STPI0COMMON_SRCDIR) distclean ; fi
	@-if [[ -e $(STPI0ANALYSIS_SRCDIR) ]] ; then $(MAKE) OUTPUT_DIR=$(OUTPUT_DIR) INCDIR=$(INCDIR) OUTPUT_NAME=$(STPI0ANALYSIS_NAME) DATASTRUCTURES_DIR=$(OUTPUT_DIR) DATASTRUCTURES_NAME=$(DATASTRUCTURES_NAME) STPI0COMMON_DIR=$(OUTPUT_DIR) STPI0COMMON_NAME=$(STPI0COMMON_NAME) -C $(STPI0ANALYSIS_SRCDIR) distclean ; fi
	@-if [[ -e $(STPI0RESULTS_SRCDIR) ]] ; then $(MAKE) OUTPUT_DIR=$(OUTPUT_DIR) INCDIR=$(INCDIR) OUTPUT_NAME=$(STPI0RESULTS_NAME) STPI0COMMON_DIR=$(OUTPUT_DIR) STPI0COMMON_NAME=$(STPI0COMMON_NAME) STPI0ANALYSIS_DIR=$(OUTPUT_DIR) STPI0ANALYSIS_NAME=$(STPI0ANALYSIS_NAME) -C $(STPI0RESULTS_SRCDIR) distclean ; fi

print:
	@echo ROOT_VER              = $(ROOT_VER)
	@echo ROOT_EXT              = $(ROOT_EXT)
	@echo STAR_HOST_SYS         = $(STAR_HOST_SYS)
	@echo STPI0COMMON_NAME         = $(STPI0COMMON_NAME)
	@echo STPI0ANALYSIS_NAME       = $(STPI0ANALYSIS_NAME)
	@echo STPI0RESULTS_NAME        = $(STPI0RESULTS_NAME)
	@echo OUTPUT_DIR            = $(OUTPUT_DIR)
	@echo STPI0COMMON_SRCDIR       = $(STPI0COMMON_SRCDIR)
	@echo STPI0ANALYSIS_SRCDIR     = $(STPI0ANALYSIS_SRCDIR)
	@echo STPI0RESULTS_SRCDIR      = $(STPI0RESULTS_SRCDIR)
