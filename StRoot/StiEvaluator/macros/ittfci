#!/usr/local/bin/perl -wall

# Usage:  ittfci
#
# 1) Makes sure the project is up to date (cvs update)
# 2) Runs RunStiMaker.C to produce Evaluation.root
# 3) Runs RunStiEvaluation.C to produce EvalHists.*
# 4) Copies EvalHists.root and EvalHists.pdf to a directory under
#    /star/data22/ITTF/EvalHistory which corresponds to the current datestamp.
#    This date may be used with "cvs history -D <datestamp>" to 
#    discover the relevant cvs versions of various files. 

# 5 Dec 2001
# Ben Norman (Kent State)

use strict;

my $evalDirName = "/star/data22/ITTF/EvalHistory";

$| = 1;  # flush output after each print

########################################
# first try to update, die on 'C'lashes

printf "Updating...";
my $result = `cvs update 2>&1`; # capture stdout and stderr
$result =~ /^C (.*)$/m and die "\nError: clash updating file $1\n";
printf "done\n";

###########################
# now make Evaluation.root

printf "Running RunStiMaker.C to produce Evaluation.root";
local *PIPE;
open(\*PIPE, "root4star -b -q StRoot/StiMaker/macros/RunStiMaker.C 2>&1 |");
my $ok = 0; while(<PIPE>){
    printf ".";
    /This is the end of ROOT -- Goodbye/ and $ok=1;
}
close(\*PIPE);
$ok or die "\nError: root terminated abnormally\n";
printf "done\n";

###########################
# now make EvalHists.*

printf "Running RunEvaluation.C to produce EvalHists.*";
open(\*PIPE,
     "root4star -b -q StRoot/StiEvaluator/macros/RunStiEvaluation.C 2>&1 |");
$ok = 0; while(<PIPE>){ 
    printf "."; 
    /This is the end of ROOT -- Goodbye/ and $ok=1;
}
close(\*PIPE);
$ok or die "\nError: root terminated abnormally\n";
printf "done\n";

############################################################
# create directory corresponding to the current time & date
my $dirName = localtime();
$dirName =~ tr/ /_/;
$dirName = "$evalDirName/$dirName";
printf "Creating directory '$dirName'...";
mkdir($dirName, 0775);
chmod(0775, $dirName); #umask makes mkdir do 0755
printf "done\n";

##############################
# copy root & pdf histo files
printf "Copying evaluation histogram files...";
$result = system("cp EvalHists.pdf EvalHists.root $dirName")/256;
$result and die "\nWarning, error copying files $1\n";
chmod(0664, "$dirName/EvalHists.pdf");
chmod(0664, "$dirName/EvalHists.root");
printf "done\n";

exit(0);

