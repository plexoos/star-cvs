#!/usr/local/bin/perl -wall

# Usage:  ittfeval
#
# this code is based on ittfci and hacked (poorly) to
# do the following
# 1) Runs RunEvaluationHistos.C to make raw corrections out of the minimc.root files
# 2) Runs RunAdditionOfHistos.C to produce a single file with all the statistics summed
# 3) Runs RunCorrectionHistos.C to make the efficiency, acceptance, histograms
#    /star/data22/ITTF/EvalHistory which corresponds to the current datestamp.
#    This date may be used with "cvs history -D <datestamp>" to 
#    discover the relevant cvs versions of various files. 

# Nov 2002
# Manuel CBS, BNL

use strict;

my $evalDirName = "/star/data22/ITTF/EvalHistory";

$| = 1;  # flush output after each print

########################################
# first try to update, die on 'C'lashes

printf "Updating...";
my $result = `cvs update 2>&1`; # capture stdout and stderr
$result =~ /^C (.*)$/m and die "\nError: clash updating file $1\n";
printf "done\n";

###########################
# step 1, needs to be replaced by a script that runs all files in a given file list

printf "Running RunEvaluationHistos.C to produce histograms";
local *PIPE;
open(\*PIPE, "root4star -b -q StRoot/StiEvaluator/macros/RunEvaluationHistos.C 2>&1 |");
my $ok = 0; while(<PIPE>){
    printf ".";
    /This is the end of ROOT -- Goodbye/ and $ok=1;
}
close(\*PIPE);
$ok or die "\nError: root terminated abnormally\n";
printf "done\n";

###########################
# step 2, adding

printf "Running RunAdditionOfHistos.C to produce Sum file";
open(\*PIPE,
     "root4star -b -q StRoot/StiEvaluator/macros/RunAdditionOfHistos.C 2>&1 |");
$ok = 0; while(<PIPE>){ 
    printf "."; 
    /This is the end of ROOT -- Goodbye/ and $ok=1;
}
close(\*PIPE);
$ok or die "\nError: root terminated abnormally\n";
printf "done\n";

###########################
# step 3, do ratios

printf "Running RunCorrectionHistos.C to produce Sum file";
open(\*PIPE,
     "root4star -b -q StRoot/StiEvaluator/macros/RunCorrectionHistos.C 2>&1 |");
$ok = 0; while(<PIPE>){ 
    printf "."; 
    /This is the end of ROOT -- Goodbye/ and $ok=1;
}
close(\*PIPE);
$ok or die "\nError: root terminated abnormally\n";
printf "done\n";

############################################################
# create directory corresponding to the current time & date
my $dirName = localtime();
$dirName =~ tr/ /_/;
$dirName = "$evalDirName/$dirName";
printf "Creating directory '$dirName'...";
mkdir($dirName, 0775);
chmod(0775, $dirName); #umask makes mkdir do 0755
printf "done\n";

##############################
# copy root & pdf histo files
printf "Copying evaluation histogram files...";
$result = system("cp StiEvalOutputRawHistos/CorHistosEvalItTest.root StiEvalOutputRawHistos/SumHistosEvalItTest.root $dirName")/256;
$result and die "\nWarning, error copying files $1\n";
printf "done\n";

exit(0);

