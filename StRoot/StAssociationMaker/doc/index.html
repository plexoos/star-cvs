<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
  <head>
    <title>StAssociationMaker Guide</title>
  </head>

  <body bgcolor="#ffffff" text="#000000">
    <table border="0" width ="100%" cellpadding="10">
      <tr bgcolor="darkblue">
	<td align="center" valign="top">
	  <h1>
	    <font color="lightgreen">StAssociationMaker</h1>
	  </h1>
	</td>
    </table>
    <center>
      <h1>A Class for <font color="red">StMcEvent-StEvent</font> Object Association</h1>
    </center>
    <p>
    <h2> New Version </h2>

    <p>
      The new version of <b>StAssociationMaker</b> is ready for testing. 
      The current <b>StAssociationMaker</b>
      User's Guide & Reference Manual
      is now outdated. Gene made a nice page where the PS documentation
      can be obtained.  Right now it is the outdated version, I'll update the information as soon as I can.
      Click
      <a href="http://www.star.bnl.gov/STARAFS/comp/root/special_docs.html">here</a> to get to Gene's page.
    <p>
      The overall idea has remained the same, but more associations
      have been added and the names of the relevant multimaps have changed because of
      this new diversity.  There are now maps for 
      <a href="#Tracks">Tracks</a>, <a href="#Vertices">Vertices</a> and
      <a href="#Hits">Hits</a>. For quick reference, look at the brief
      <a href="#class description">class description</a> below.  This gives a list of
      the most relevant multimap type definitions (or "What was the name of the map between TPC Hits?")
      , and the methods
      to <a href="#Getting">get the maps</a> from the <i>StAssociationMaker</i> class (or "How do I get the maps
      once I have a pointer to the Association Maker?").

    </p>
    <h2> Description </h2>
    <p>
      The <b>StAssociationMaker</b> package provides the functionality to analyze Monte Carlo
      data contained in <b>StMcEvent</b> and reconstructed data contained in <b>StEvent</b>.  It relates the
      objects from the 2 packages according to user defined criteria.  The relationship is
      established through a <i>multimap</i>.  For a better understanding of the workings of the Maker,
      I'll very briefly discuss the idea behind a <i>multimap</i>.
    </p>
    <h2>Quick glance at Multimaps</h2>
    <p>
      A <a href="http://www.sgi.com/Technology/STL/Multimap.html"><i>multimap</i></a> is a type of C++
      <a href="http://www.sgi.com/Technology/STL/stl_introduction.html">Standard Template Library</a>
      associative container.  The crucial idea for
      <a href="http://www.sgi.com/Technology/STL/Map.html"><i>maps</i></a> (and indeed, for all types of
      associative containers) is to gain information based on a "key".  To illustrate the concept
      in a more familiar context, one can think of a phonebook.  The idea of a phonebook is that it
      contains people's phone numbers.  In other words, it is an associative container between a
      character string (a person's name) and an integer (the person's phone number).  To use a phonebook,
      one looks up a person's name and reads off the associated phone number.  The character
      string representing the name is the "key", and the phone number is the key's associated "value".
    </p>
    <p>
      A <i>map</i> is nothing else than a sequence of (key, value) pairs that provides for fast retrieval
      of the value based on the key.  There is one main difference between the <i>map</i> and the
      <i>multimap</i>:in a <i>map</i>,
      keys are UNIQUE.  This means that if a phonebook were a <i>map</i>,
      then each person would only
      be able to have one phone number. Note that the phone number could be shared between people
      (only the keys
      are unique).  A <i>multimap</i>, on the other hand,
      allows multiple keys.  This means that if a phonebook were a <i>multimap</i>, then everyone could have
      as many phone numbers as they pleased.
      
    </p>
    <hr>
    <h2> Multimaps Implemented in the Package </h2>
    <p>
      The following multimaps are now implemented in <b>StAssociatonMaker</b>:
    </p>
    <ul>
      <li> TPC Hits</li>
      <li> SVT Hits</li>
      <li> FTPC Hits</li>
      <li> Tracks  (using all the previous hit multimaps)</li>
      <li> Kink Vertices </li>
      <li> V0 Vertices </li>
      <li> Xi Vertices </li>
      
    </ul>
    <p>
      The association is made based on criteria given by the user.  These criteria are
      established at runtime, and the user controls them at the macro level.
    </p>
    <p>
      For the
      Hit multimaps, the criterion is spatial proximity.  That is, if 2 hits are closer
      in space than a certain distance cut, they are associated.
      Note that all associations are done in GLOBAL coordinates.
      The user specifies the
      desired distance cut at the macro level.  This can be seen in the example macro
      <pre>$STAR/StRoot/macros/examples/StAssociator.C </pre>
    <p>
      
      For the Track multimap, the criterion is based on the number of hits the tracks share in common.
      This means that to build the Track Multimap, the TPC Hit Multimap is used.  When the relevant
      Hit Multimaps are implemented for the other detectors, these will be used too.  The user specifies
      the minimum number of hits the tracks must share in order to be associated.
    </p>
    
    The defaults are:
    <pre>
    TPC Cuts
    X Cut    : 5 mm
    Y Cut    : 5 mm
    Z Cut    : 2 mm
    Required TPC Hits for Associating Tracks : 3
    SVT Cuts
    X Cut    : 1 mm
    Y Cut    : 1 mm
    Z Cut    : 1 mm
    Required SVT Hits for Associating Tracks : 1
    FTPC Cuts
    R Cut    : 3 mm
    Phi Cut  : 5 degrees
    Required FTPC Hits for Associating Tracks : 3
    </pre>
    
    <hr>
    <h2> Running the Code</h2>
    <p>
    The macro to use is:
    </p>
    <p>
      <font face="courier">$STAR/StRoot/macros/examples/<b>StAssociator.C</b></font>
    </p>
    <p>
       The code compiles and runs on Linux, Solaris and HP.
      Make sure that you are in one of the libraries that has the new <b>StEvent</b>
      and the new <b>StMcEvent</b> (at least SL99j).
      For this example, we'll assume the "dev" version.  Please note that as time goes by,
      libraries are moved and what once was "dev" becomes "new" and so on.  Keep this in mind
      when you try to run this and make sure you understand which libraries have what.  The libraries
      should be built, and the macros are in the macro search path. There is a very important
      thing to keep in mind when using <b>StAssociationMaker</b> or any code that uses  <b>StEvent</b>
      is that these packages RELY ON THE NEW DST TABLES.  This means that to use them you have to make
      sure that the *.dst.root file you want to use can actually be read by  <b>StEvent</b>.  Moreover,
      most of the new dst files are NOT produced with their *.geant.root file.  So before running
      <b>StAssociationMaker</b>, make sure that
    <ul>
      <li> You are using a dst.root file that can be read by the new <b>StEvent</b>.
      <li> The geant.root file from the dst.root file you want to use was written out.
      <li> Both files are in the same directory.
    </ul>
    An example invocation using files generated by Lidia is : 
    <pre>
  > mkdir workdir
  > cd workdir
  > klog
  > root4star
  root4star[0] .x StAssociator.C(1,"/star/rcf/test/request/psc0208_01_40evts.geant.root")
    </pre>
	  
    </p>
    <p>
      This will run a chain where all the needed packages are loaded and run.  After
      StAssociationMaker is called, a user would normally have their own analysis package.
      With this in mind, an example analysis package is also provided:
      <b>StMcAnalysisMaker</b>.
      This Maker illustrates the use of <b>StAssociationMaker</b>
      to do simple histogramming and creation of an Ntuple.  The Maker already takes care of
      getting the pointers to <b>StEvent</b>, <b>StMcEvent</b>, and <b>StAssociationMaker</b>.
      Instead of starting from scratch a user would create her own analysis maker following the
      examples illustrated in this maker.  These are:
    </p>
    <ul>
      <li> Print the primary vertex position from StEvent and from StMcEvent to the screen.</li>
      <li> Print the position of the first reconstructed TPC Hit in the multimap, and then print
	the position of the associated MC TPC hit for comparison.</li>
      <li> 2-D Histogram of X position difference vs. Y position difference of all TPC hits
	in the multimap. </li>
      <li> Print the magnitude of the momentum of the first reconstructed track in the multimap, and
	then print the magnitude of the momentum of any associated MC Tracks for comparison.</li>
      <li> 1-D Histogram of the momentum resolution: (p - p<sub>MC</sub>)/p</li>
      <li> Ntuple containing the following information for each track pair:
	<ul>
	  <li> Reconstructed momentum (components and magnitude)
	  <li> Monte Carlo momentum (components and magnitude)
	  <li> Number of common TPC Hits
	  <li> mean of the hit position difference in each spatial direction
	</ul>
      <li> Two 2-D Histograms: X vs. Y position of the hits from a Reconstructed track, and
	from its associated Monte Carlo track.
	
    </ul>

    <hr>
    <a name="class description"></a>
    <h2> Brief Class Description</h2>
    <b>StAssociationMaker</b> defines several type definitions to simplify the declaration of the several
    multimaps and their value_types, iterators, etc.
    Also,
    for every type of association, 2 multimaps are provided.  One takes the reconstructed object
    as "key" and the other takes the Monte Carlo object as "key".  The naming convention
    to distinguish the 2 cases is to add the prefixes "rc" and "mc".  To illustrate a typical type
    definition of these maps, the multimap for Tpc Hits that takes the reconstructed object
    (<i>StTpcHit</i>)
    as key is defined as:
    <pre>
 typedef multimap< const StTpcHit*, const StMcTpcHit*, compTpcHit> rcTpcHitMapType;
    </pre>
    The most commonly used of these will be the multimaps themselves and their iterators.  These are
    listed below.
    
    <a name="Hits"></a>
    <h3>Hits</h3>
    
    <p> <i>Tpc Hits</i> </p>
    <pre>
    rcTpcHitMapType     
    rcTpcHitMapIter 

    mcTpcHitMapType  
    mcTpcHitMapIter   
    </pre>
    <p> <i>Svt Hits</i> </p>
    <pre>
    rcSvtHitMapType    
    rcSvtHitMapIter     

    mcSvtHitMapType   
    mcSvtHitMapIter   
    </pre>
    <p> <i>Svt Hits</i> </p>
    <pre>
    rcFtpcHitMapType    
    rcFtpcHitMapIter    

    mcFtpcHitMapType  
    mcFtpcHitMapIter  
    </pre>
    <a name="Tracks"></a>
    <h3>Tracks</h3>

    The tracks are built based on the Hit map associations. The reconstructed object used is
    <i>StGlobalTrack</i> because it is the more general type of track in <b>StEvent</b>.  The track
    multimap differs from the Hit and Vertex multimap in that one not just wants to find out
    which tracks are associated, but there is other information that the association can give.
    For example, one would want to easily find out how many TPC, SVT and FTPC hits do the tracks
    have in common.  This information then really belongs in another class, in this case
    <i>StTrackPairInfo</i>.  The track maps are then between a pointer to a track and a pointer to an
    <i>StTrackPairInfo</i>.  The "get" methods of this class are:

    <pre>
    StMcTrack* partnerMcTrack() const;
    StGlobalTrack* partnerTrack() const;

    unsigned int commonTpcHits() const;
    unsigned int commonSvtHits() const;
    unsigned int commonFtpcHits() const;

    float percentOfPairedTpcHits() const;
    float percentOfPairedSvtHits() const;
    float percentOfPairedFtpcHits() const;
    </pre>
    <p>
      The "percent" method really returns the ratio between the number of common hits and the total number of
      hits the <i>StGlobalTrack</i> has.

    <p>
      The relevant multimap type definitions for tracks are:
    <pre>
    rcTrackMapType
    rcTrackMapIter
    rcTrackMapConstIter

    mcTrackMapType
    mcTrackMapIter
    mcTrackMapConstIter

    </pre>
    
    <a name="Vertices"></a>
    <h3>Vertices</h3>
    The vertices are associated depending on the association between the parent and daughter tracks
    of each vertex.  Like the hits, this is more a Yes/No type of association.  The type definitions are:
    
    <p> <i>Kinks</i> </p>
    <pre>
    rcKinkMapType
    rcKinkMapIter
    rcKinkMapConstIter

    mcKinkMapType
    mcKinkMapIter
    mcKinkMapConstIter

    </pre>
    <p> <i>V0s</i> </p>
    <pre>
    rcV0MapType
    rcV0MapIter
    rcV0MapConstIter

    mcV0MapType
    mcV0MapIter
    mcV0MapConstIter

    </pre>
    <p> <i>Xis</i> </p>
    <pre>
    rcXiMapType
    rcXiMapIter
    rcXiMapConstIter

    mcXiMapType
    mcXiMapIter
    mcXiMapConstIter

    </pre>
    <a name="Getting"></a>
    <h3>Getting the Maps</h3>
    
    <p>
      The multimaps are accessed via the <i>StAssociationMaker</i> class.  The methods to get them, and their
      return types, are:
    <pre>
    rcTpcHitMapType*  rcTpcHitMap()  
    mcTpcHitMapType*  mcTpcHitMap()

    rcSvtHitMapType*  rcSvtHitMap()  
    mcSvtHitMapType*  mcSvtHitMap()  

    rcFtpcHitMapType* rcFtpcHitMap() 
    mcFtpcHitMapType* mcFtpcHitMap() 

    rcTrackMapType*   rcTrackMap()   
    mcTrackMapType*   mcTrackMap()   

    rcKinkMapType*    rcKinkMap()    
    mcKinkMapType*    mcKinkMap()    

    rcV0MapType*      rcV0Map()      
    mcV0MapType*      mcV0Map()      

    rcXiMapType*      rcXiMap()      
    mcXiMapType*      mcXiMap()      

    </pre>

    This are the basic types and methods needed to access the multimaps in <b>StAssociationMaker</b>.
    Please look at <b>StMcAnalysisMaker</b> since it is really a working example of how to use
    <b>StAssociationMaker</b>.
    <hr>
    <b>StAssociationMaker</b> is a work in progress.  For questions, contact
    <address><a href="mailto:calderon@star.physics.yale.edu">Manuel Calderon de la Barca Sanchez</a></address>
    or
    <address><a href="mailto:lisa@mps.ohio-state.edu">Michael A. Lisa</a></address>
<!-- Created: Mon Sep 27 15:18:56 EDT 1999 -->
<!-- hhmts start -->
Last modified: Tue Jan 11 18:10:37 EST 2000
<!-- hhmts end -->
  </body>
</html>
